<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MyBatis,">










<meta name="description" content="第三章 映射文件解析3.1 映射文件解析入口映射文件的解析过程是配置文件解析过程的一部分， MyBatis会在解析配置文件的过程中对映射文件进行解析。解析逻辑封装在mapperElement()方法中，我们把这个方法作为本章的总入口方法。 这个方法主要对&amp;lt;mappers&amp;gt;的每个子节点，按照不同的类型和属性，进行不同方式的解析，具体分派过程我放在源代码的注释中。 123456789101">
<meta name="keywords" content="MyBatis">
<meta property="og:type" content="article">
<meta property="og:title" content="[MyBatis源码][3][映射文件的解析过程]">
<meta property="og:url" content="http://yoursite.com/2020/03/24/MyBatis源码-3-映射文件的解析过程/index.html">
<meta property="og:site_name" content="打怪升级日常">
<meta property="og:description" content="第三章 映射文件解析3.1 映射文件解析入口映射文件的解析过程是配置文件解析过程的一部分， MyBatis会在解析配置文件的过程中对映射文件进行解析。解析逻辑封装在mapperElement()方法中，我们把这个方法作为本章的总入口方法。 这个方法主要对&amp;lt;mappers&amp;gt;的每个子节点，按照不同的类型和属性，进行不同方式的解析，具体分派过程我放在源代码的注释中。 123456789101">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://i.loli.net/2020/03/21/AHKVodpUer1SyZ5.png">
<meta property="og:image" content="https://i.loli.net/2020/03/21/AWavRPJoXM6Tpt7.png">
<meta property="og:image" content="https://i.loli.net/2020/03/22/AOcWNLmzvPgh9SY.png">
<meta property="og:image" content="https://i.loli.net/2020/03/22/Js3PGbzmCI6yRux.png">
<meta property="og:image" content="https://i.loli.net/2020/03/22/pwUle9y8631tfkr.png">
<meta property="og:image" content="https://i.loli.net/2020/03/24/RwCIX1W248Hht6g.png">
<meta property="og:image" content="https://i.loli.net/2020/03/24/oAYu5OQvDWMeGUm.png">
<meta property="og:image" content="https://i.loli.net/2020/03/24/xW2ROFrvbgfpXAl.png">
<meta property="og:updated_time" content="2020-03-24T03:15:18.678Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[MyBatis源码][3][映射文件的解析过程]">
<meta name="twitter:description" content="第三章 映射文件解析3.1 映射文件解析入口映射文件的解析过程是配置文件解析过程的一部分， MyBatis会在解析配置文件的过程中对映射文件进行解析。解析逻辑封装在mapperElement()方法中，我们把这个方法作为本章的总入口方法。 这个方法主要对&amp;lt;mappers&amp;gt;的每个子节点，按照不同的类型和属性，进行不同方式的解析，具体分派过程我放在源代码的注释中。 123456789101">
<meta name="twitter:image" content="https://i.loli.net/2020/03/21/AHKVodpUer1SyZ5.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/03/24/MyBatis源码-3-映射文件的解析过程/">





  <title>[MyBatis源码][3][映射文件的解析过程] | 打怪升级日常</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/T0UGH" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">打怪升级日常</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">两星炸弹人(╯‵□′)╯炸弹！•••</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/24/MyBatis源码-3-映射文件的解析过程/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="T0UGH(GuiPing Wang)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://i.loli.net/2020/03/21/WAKimNUecFR64uo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="打怪升级日常">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">[MyBatis源码][3][映射文件的解析过程]</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T11:13:07+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index">
                    <span itemprop="name">MyBatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/24/MyBatis源码-3-映射文件的解析过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/24/MyBatis源码-3-映射文件的解析过程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="第三章-映射文件解析"><a href="#第三章-映射文件解析" class="headerlink" title="第三章 映射文件解析"></a>第三章 映射文件解析</h2><h3 id="3-1-映射文件解析入口"><a href="#3-1-映射文件解析入口" class="headerlink" title="3.1 映射文件解析入口"></a>3.1 映射文件解析入口</h3><p><strong>映射文件的解析</strong>过程是<strong>配置文件解析</strong>过程的<strong>一部分</strong>， MyBatis会在解析配置文件的过程中对映射文件进行解析。解析逻辑封装在<code>mapperElement()</code>方法中，我们把这个方法作为本章的总入口方法。</p>
<p>这个方法主要对<code>&lt;mappers&gt;</code>的每个子节点，按照不同的类型和属性，进行不同方式的解析，具体分派过程我放在源代码的注释中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.0</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLConfigBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//一、解析&lt;package&gt;子节点</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"package"</span>.equals(child.getName())) &#123;</span><br><span class="line">                String mapperPackage = child.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">                configuration.addMappers(mapperPackage);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//二、解析&lt;mapper&gt;子节点</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//获取&lt;mapper&gt;节点的resource、url、mapperClass属性</span></span><br><span class="line">                String resource = child.getStringAttribute(<span class="string">"resource"</span>);</span><br><span class="line">                String url = child.getStringAttribute(<span class="string">"url"</span>);</span><br><span class="line">                String mapperClass = child.getStringAttribute(<span class="string">"class"</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//根据读取到的属性哪几个为空，来选择不同的解析方式，总共有4条路</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//① 根据resource解析</span></span><br><span class="line">                <span class="keyword">if</span> (resource != <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    </span><br><span class="line">                    ErrorContext.instance().resource(resource);</span><br><span class="line">                    InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">                    </span><br><span class="line">                    XMLMapperBuilder mapperParser </span><br><span class="line">                        = <span class="keyword">new</span> XMLMapperBuilder(inputStream, </span><br><span class="line">                                             configuration, </span><br><span class="line">                                             resource,</span><br><span class="line">                                             configuration.getSqlFragments());</span><br><span class="line">                    </span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//② 根据url解析    </span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url != <span class="keyword">null</span> &amp;&amp; mapperClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                    ErrorContext.instance().resource(url);</span><br><span class="line">                    InputStream inputStream = Resources.getUrlAsStream(url);</span><br><span class="line">                    </span><br><span class="line">                    XMLMapperBuilder mapperParser </span><br><span class="line">                        = <span class="keyword">new</span> XMLMapperBuilder(inputStream,</span><br><span class="line">                                               configuration,</span><br><span class="line">                                               url,</span><br><span class="line">                                               configuration.getSqlFragments());</span><br><span class="line">                    </span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//③ 根据mapperClass解析</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="keyword">null</span> &amp;&amp; url == <span class="keyword">null</span> &amp;&amp; mapperClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    </span><br><span class="line">                    Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">                    configuration.addMapper(mapperInterface);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//④ 都没有就直接报错    </span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"A mapper element may only"</span></span><br><span class="line">                                               + <span class="string">"specify a url, resource or class,"</span> </span><br><span class="line">                                               + <span class="string">"but not more than one."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码段<code>3.0</code>中，我们可以看出，对于某个节点的解析逻辑，主要放在<code>XMLMapperBuilder</code>的<code>parse()</code>方法中，这个<code>parse()</code>方法主要包含如下几步</p>
<ol>
<li><code>mapper</code>节点的具体解析过程</li>
<li>将这个节点设置为已加载</li>
<li>通过命名空间绑定<code>Mapper</code>接口</li>
<li>处理各个未完成解析的节点</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.1</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"><span class="comment">//Mapper的解析过程</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//如果配置文件没有被加载过，就开始对这个XMLMapperBuilder进行解析</span></span><br><span class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">      	</span><br><span class="line">        <span class="comment">//① mapper节点的具体解析过程</span></span><br><span class="line">        configurationElement(parser.evalNode(<span class="string">"/mapper"</span>));</span><br><span class="line">      	</span><br><span class="line">        <span class="comment">//② 将资源设置为已经加载</span></span><br><span class="line">        configuration.addLoadedResource(resource);</span><br><span class="line">      	</span><br><span class="line">        <span class="comment">//③ 通过命名空间绑定Mapper接口</span></span><br><span class="line">        bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//④ 解析各个未完成解析的节点</span></span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-解析映射文件"><a href="#3-2-解析映射文件" class="headerlink" title="3.2 解析映射文件"></a>3.2 解析映射文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.2</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"><span class="comment">//对于单个mapper节点的具体解析过程</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configurationElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//① 获得mapper命名空间</span></span><br><span class="line">        String namespace = context.getStringAttribute(<span class="string">"namespace"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//② 判断命名空间是否为空，为空报异常</span></span><br><span class="line">        <span class="keyword">if</span> (namespace == <span class="keyword">null</span> || namespace.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Mapper's namespace cannot be empty"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//③ 设置当前命名空间</span></span><br><span class="line">        builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//④ 解析&lt;cache-ref&gt;节点</span></span><br><span class="line">        cacheRefElement(context.evalNode(<span class="string">"cache-ref"</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//⑤ 解析&lt;cache&gt;节点</span></span><br><span class="line">        cacheElement(context.evalNode(<span class="string">"cache"</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//⑥ 解析所有&lt;parameterMap&gt;节点，parameterMap主要考虑到可能传入sql的参数过于复杂</span></span><br><span class="line">        parameterMapElement(context.evalNodes(<span class="string">"/mapper/parameterMap"</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//⑦ 解析所有&lt;resultMap&gt;节点</span></span><br><span class="line">        resultMapElements(context.evalNodes(<span class="string">"/mapper/resultMap"</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//⑧ 解析所有&lt;sql&gt;节点</span></span><br><span class="line">        sqlElement(context.evalNodes(<span class="string">"/mapper/sql"</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//⑨ 解析所有&lt;select|insert|update|delete&gt;节点</span></span><br><span class="line">        buildStatementFromContext(context.evalNodes(<span class="string">"select|insert|update|delete"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error parsing Mapper XML. The XML location is '"</span> </span><br><span class="line">                                   + resource </span><br><span class="line">                                   + <span class="string">"'. Cause: "</span> </span><br><span class="line">                                   + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码段，我们可以得知，<code>configurationElement()</code>主要对单个<code>&lt;mapper&gt;</code>节点的各个类型的子节点进行解析，包括<code>&lt;cache&gt;</code>、<code>&lt;cache-ref&gt;</code>、<code>&lt;parameterMap&gt;</code>、<code>&lt;resultMap&gt;</code>、<code>&lt;sql&gt;</code>、<code>&lt;select&gt;</code>、<code>&lt;insert&gt;</code>、<code>&lt;update&gt;</code>、<code>&lt;delete&gt;</code>等子节点。在本节的剩余部分，我们将挑选几个有特点的<code>&lt;mapper&gt;</code>节点的子节点进行解析。</p>
<h4 id="3-2-1-解析-lt-cache-gt-节点"><a href="#3-2-1-解析-lt-cache-gt-节点" class="headerlink" title="3.2.1 解析&lt;cache&gt;节点"></a>3.2.1 解析<code>&lt;cache&gt;</code>节点</h4><p>MyBatis提供了一、二级缓存，其中一级缓存是<code>SqlSession</code>级别的，默认为开启状态。二级缓存配置在映射文件中，使用者需要显式配置才能开启。</p>
<p>下面的代码段给出了一个配置二级缓存的例子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--id:3.3--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cache</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">eviction</span>=<span class="string">"FIFO"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">flushInterval</span>=<span class="string">"60000"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">size</span>=<span class="string">"512"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">readOnly</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么我们废话少说，从代码块<code>3.2</code>的22行<code>cacheElement(context.evalNode(&quot;cache&quot;));</code>向下，具体分析<code>cacheElement()</code>方法的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.4</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheElement</span><span class="params">(XNode context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//① 取得&lt;cache&gt;节点的各个属性</span></span><br><span class="line">        String type = context.getStringAttribute(<span class="string">"type"</span>, <span class="string">"PERPETUAL"</span>);</span><br><span class="line">        Class&lt;? extends Cache&gt; typeClass = typeAliasRegistry.resolveAlias(type);</span><br><span class="line">        </span><br><span class="line">        String eviction = context.getStringAttribute(<span class="string">"eviction"</span>, <span class="string">"LRU"</span>);</span><br><span class="line">        Class&lt;? extends Cache&gt; evictionClass =	</span><br><span class="line">            typeAliasRegistry.resolveAlias(eviction);</span><br><span class="line">        </span><br><span class="line">        Long flushInterval = context.getLongAttribute(<span class="string">"flushInterval"</span>);</span><br><span class="line">        </span><br><span class="line">        Integer size = context.getIntAttribute(<span class="string">"size"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span> readWrite = !context.getBooleanAttribute(<span class="string">"readOnly"</span>, <span class="keyword">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span> blocking = context.getBooleanAttribute(<span class="string">"blocking"</span>, <span class="keyword">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//② 取得各个节点的子节点配置，其实还是一些属性</span></span><br><span class="line">        Properties props = context.getChildrenAsProperties();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//③ 调用MapperBuilderAssistant这个助手类，构建一个新的缓存，并存入Configuration中</span></span><br><span class="line">        builderAssistant.useNewCache(typeClass,</span><br><span class="line">                                     evictionClass,</span><br><span class="line">                                     flushInterval,</span><br><span class="line">                                     size,</span><br><span class="line">                                     readWrite,</span><br><span class="line">                                     blocking,</span><br><span class="line">                                     props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>cacheElement</code>方法的逻辑还是比较简单的，它从<code>&lt;cache&gt;</code>节点上读取各种配置，然后使用这些配置。调用<code>Mapper</code>建造助手来构建一个新的缓存。下面我们从这个代码段的27行<code>builderAssistant.useNewCache(typeClass,evictionClass,flushInterval,size,readWrite,blocking,props);</code>向下，具体分析缓存的构造过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.5</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder;</span></span><br><span class="line"><span class="comment">//MapperBuilderAssistant</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">useNewCache</span><span class="params">(Class&lt;? extends Cache&gt; typeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Class&lt;? extends Cache&gt; evictionClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Long flushInterval,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Integer size,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">boolean</span> readWrite,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">boolean</span> blocking,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Properties props)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//① 使用CacheBuilder，它是一个Cache的建造者，来一步一步建造一个Cache</span></span><br><span class="line">    Cache cache = <span class="keyword">new</span> CacheBuilder(currentNamespace)</span><br><span class="line">        .implementation(valueOrDefault(typeClass, PerpetualCache.class))</span><br><span class="line">        .addDecorator(valueOrDefault(evictionClass, LruCache.class))</span><br><span class="line">        .clearInterval(flushInterval)</span><br><span class="line">        .size(size)</span><br><span class="line">        .readWrite(readWrite)</span><br><span class="line">        .blocking(blocking)</span><br><span class="line">        .properties(props)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//② 将这个新建好的Cache加入Configuration的Cache池中存放</span></span><br><span class="line">    configuration.addCache(cache);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//③ 没啥用</span></span><br><span class="line">    currentCache = cache;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们继续深入源代码之前，首先我想介绍一个Mybatis的<code>Cache</code>接口极其实现类的设计。它使用一个装饰器模式。首先<code>Cache</code>接口有一个普通实现，<code>PerpetualCache</code>，它仅提供最基本的缓存功能，如果还需要其他功能，就需要将这个类作为<code>delegate</code>，包装到<code>Cache</code>接口的其他装饰器，例如，若我们想让<code>Cache</code>具有日志功能，就使用<code>LoggingCache</code>。下图展示了<code>Cache</code>接口的大量实现。</p>
<p><img src="https://i.loli.net/2020/03/21/AHKVodpUer1SyZ5.png" alt=""></p>
<p>在了解了<code>Cache</code>接口的设计后，我们从<code>3.5</code>代码段的第21行<code>CacheBuilder.build()</code>向下，看看<code>build()</code>具体做了什么工作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.6</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//CacheBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//① 设置默认的缓存类型和缓存装饰器</span></span><br><span class="line">    setDefaultImplementations();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//② 通过反射的方式，根据Class类的实例implementation来选择Cache接口合适的实现类来创建Cache</span></span><br><span class="line">    Cache cache = newBaseCacheInstance(implementation, id);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//③ 根据用户定义，设置这个cache的属性</span></span><br><span class="line">    setCacheProperties(cache);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// issue #352, do not apply decorators to custom caches</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//④ 若这个cache是PropertualCache(Cache的默认实现，没有任何装饰器)，则为它配置默认装饰器</span></span><br><span class="line">    <span class="keyword">if</span> (PerpetualCache.class.equals(cache.getClass())) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends Cache&gt; decorator : decorators) &#123;</span><br><span class="line">            cache = newCacheDecoratorInstance(decorator, cache);</span><br><span class="line">            setCacheProperties(cache);</span><br><span class="line">        &#125;</span><br><span class="line">        cache = setStandardDecorators(cache);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//⑤. 如果这个cache没有使用任何日志装饰器，则加一个日志装饰器</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!LoggingCache.class.isAssignableFrom(cache.getClass())) &#123;</span><br><span class="line">        cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第13行的<code>setCacheProperties(cache);</code>主要将<code>&lt;cache&gt;</code>节点的各个<code>&lt;property&gt;</code>子节点设置进<code>Cache</code>的具体实现中，这个没什么可分析的，跳过它。这里，我们继续分析23行的<code>cache = setStandardDecorators(cache);</code>看看<code>PerpetualCache</code>都会被设置哪些标准装饰器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.7</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//CacheBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Cache <span class="title">setStandardDecorators</span><span class="params">(Cache cache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//① 将size属性设置进PerpetualCache实例中</span></span><br><span class="line">        MetaObject metaCache = SystemMetaObject.forObject(cache);</span><br><span class="line">        <span class="keyword">if</span> (size != <span class="keyword">null</span> &amp;&amp; metaCache.hasSetter(<span class="string">"size"</span>)) &#123;</span><br><span class="line">            metaCache.setValue(<span class="string">"size"</span>, size);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//② 如果前面代码清单3.4传入的clearInterval不为空，则加一个ScheduledCache`</span></span><br><span class="line">        <span class="keyword">if</span> (clearInterval != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cache = <span class="keyword">new</span> ScheduledCache(cache);</span><br><span class="line">            ((ScheduledCache) cache).setClearInterval(clearInterval);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//③ 如果readWrite标志开启，也就是读写锁功能开启，则加一个SerializedCache</span></span><br><span class="line">        <span class="keyword">if</span> (readWrite) &#123;</span><br><span class="line">            cache = <span class="keyword">new</span> SerializedCache(cache);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//④ 加一个LoggingCache</span></span><br><span class="line">        cache = <span class="keyword">new</span> LoggingCache(cache);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//⑤ 加一个SynchronizedCache</span></span><br><span class="line">        cache = <span class="keyword">new</span> SynchronizedCache(cache);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//⑥ 如果blocking标记开启，加一个BlockingCache</span></span><br><span class="line">        <span class="keyword">if</span> (blocking) &#123;</span><br><span class="line">            cache = <span class="keyword">new</span> BlockingCache(cache);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//⑦ 返回这个装饰过后的cache</span></span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合上述代码，这里画一个图，来表示标准装饰器的装饰顺序</p>
<p><img src="https://i.loli.net/2020/03/21/AWavRPJoXM6Tpt7.png" alt=""></p>
<h4 id="3-2-2-解析-lt-resultMap-gt-节点"><a href="#3-2-2-解析-lt-resultMap-gt-节点" class="headerlink" title="3.2.2 解析&lt;resultMap&gt;节点"></a>3.2.2 解析<code>&lt;resultMap&gt;</code>节点</h4><p>对于<code>resultMap</code>，引用官方文档的一段话，来说明其强大作用。</p>
<blockquote>
<p>resultMap元素是MyBatis中最重要最强大的元素。它可以让你从90%的 JDBC ResultSet数据提取代码中解放出来，并在一些情形下允许你做一些JBC不支持的事情。实际上，在对复杂语句进行联合映射的时候，它很可能可以代替数千行的同等功能的代码。 ResultMap的设计思想是，简单的语句不需要明确的结果映射，而复杂一点的语句只需要描述它们的关系就行了。</p>
</blockquote>
<p>在分析源代码之前我们使用一个复杂的<code>resultMap</code>的例子来展示它的强大功能</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--id:3.8--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resulpMap</span> <span class="attr">type</span>=<span class="string">"com.edu.neu.pojo.Employee"</span> <span class="attr">id</span>=<span class="string">"employee"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">idArg</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">javaType</span>=<span class="string">"int"</span> <span class="attr">jdbcType</span>=<span class="string">"INT"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">column</span>=<span class="string">"real_name"</span> <span class="attr">property</span>=<span class="string">"realName"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg</span> <span class="attr">column</span>=<span class="string">"email"</span> <span class="attr">property</span>=<span class="string">"email"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"real_name"</span> <span class="attr">property</span>=<span class="string">"realName"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"sex"</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">typeHandler</span>=<span class="string">"com.edu.neu.Handler.SexTypeHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"email"</span> <span class="attr">property</span>=<span class="string">"email"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"workCard"</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">select</span>=<span class="string">"com.edu.neu.mapper.WorkCardMapper.getWorkCardByEmpId"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"employeeTaskList"</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">select</span>=<span class="string">"com.edu.neu.mapper.EmployeeTaskMapper.getEmployeeTaskByEmpId"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resulpMap</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个例子几乎把<code>&lt;resultMap&gt;</code>的子节点演示遍了。下面解释一下这些子节点的作用</p>
<ul>
<li><code>constructor</code>元素：用来配置一个构造方法。MyBatis会根据这个配置找到合适的构造方法对这个类实例化</li>
<li><code>result</code>元素：配置的是POJO成员变量到SQL列的映射关系，<code>column</code>代表SQL列名，<code>property</code>代表属性名</li>
<li><code>id</code>元素：除了具有<code>result</code>元素的功能，还表示了哪个列是主键，其实就是唯一标识列，不一定非要是主键。</li>
<li><code>association</code>元素：用来配置一个一对一的级联，例如上述代码段：当使用这个<code>resultMap</code>时，还会顺便把<code>WorkCard</code>也根据<code>id</code>从数据库中取出</li>
<li><code>collection</code>元素：与<code>association</code>元素类似，也是完成级联，但是它用于一对多级联，它将返回一个<code>java.util.List</code></li>
<li>其他子节点并不常见，这里就不介绍了。</li>
</ul>
<p>在正式分析解析逻辑之前，我们先看看存储结构，所有解析完成的<code>ResultMap</code>都将存放在<code>Configuration</code>的成员变量<code>resultMaps</code>中，这个<code>Map</code>的键为我们为<code>&lt;resultMap&gt;</code>节点指定的<code>id</code>属性，例如代码清单<code>3.8</code>的<code>employee</code>就将成为这个<code>resultMap</code>的<code>key</code>。而值为一个<code>org.apache.ibatis.mapping.ResultMap</code>的实例，这个类存储了单个<code>&lt;resultMap&gt;</code>的解析结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.9</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.session;</span></span><br><span class="line"><span class="comment">//Configuration</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, ResultMap&gt; resultMaps </span><br><span class="line">      = <span class="keyword">new</span> StrictMap&lt;&gt;(<span class="string">"Result Maps collection"</span>);</span><br></pre></td></tr></table></figure>
<p>下面我们再看看上文中提到的<code>org.apache.ibatis.mapping.ResultMap</code>中都存放了什么吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.10</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//ResultMap</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultMap</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个configuration的引用，主要用来操作configuration来存放解析结果</span></span><br><span class="line">  	<span class="keyword">private</span> Configuration configuration;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这个&lt;resultMap&gt;的id属性，唯一标识符</span></span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这个&lt;resultMap&gt;的type属性，被解析为了一个Class对象</span></span><br><span class="line">  	<span class="keyword">private</span> Class&lt;?&gt; type;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//用于存放&lt;resultMap&gt;的各个&lt;result&gt;、&lt;id&gt;节点、以及&lt;contructor&gt;中的&lt;idArg&gt;、&lt;arg&gt;节点的解析结果</span></span><br><span class="line">  	<span class="keyword">private</span> List&lt;ResultMapping&gt; resultMappings;</span><br><span class="line">  	</span><br><span class="line">    <span class="comment">//用于存放&lt;resultMap&gt;中&lt;id&gt;节点的解析结果</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ResultMapping&gt; idResultMappings;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//用来存放&lt;resultMap&gt;中&lt;constructor&gt;节点的所有解析结果</span></span><br><span class="line">  	<span class="keyword">private</span> List&lt;ResultMapping&gt; constructorResultMappings;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//用于存放&lt;resultMap&gt;中&lt;result&gt;节点的解析结果</span></span><br><span class="line">  	<span class="keyword">private</span> List&lt;ResultMapping&gt; propertyResultMappings;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//用来存放SQL表所有被映射的列的列名</span></span><br><span class="line">  	<span class="keyword">private</span> Set&lt;String&gt; mappedColumns;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//用来存放POJO所有被映射的属性的属性名</span></span><br><span class="line">  	<span class="keyword">private</span> Set&lt;String&gt; mappedProperties;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个鉴别器，不常用，不分析</span></span><br><span class="line">  	<span class="keyword">private</span> Discriminator discriminator;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个标志，是否有嵌套的ResultMap</span></span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个标志，是否有嵌套的查询</span></span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedQueries;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个标志，是否开启了自动映射</span></span><br><span class="line">  	<span class="keyword">private</span> Boolean autoMapping;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实，说白了，就是把单个<code>&lt;result&gt;</code>、<code>&lt;id&gt;</code>的解析结果，按照不同的类型，在不同的<code>List</code>中存放了起来，仅此而已。下图是个很好的例子。</p>
<p><img src="https://i.loli.net/2020/03/22/AOcWNLmzvPgh9SY.png" alt=""></p>
<p>但是这还没完，上述代码块用到的<code>ResultMapping</code>类，它看起来是存储单个POJO-SQL映射的类，我们接着分析它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.11</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//ResultMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultMapping</span> </span>&#123;</span><br><span class="line">	<span class="comment">//一个configuration的引用</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br><span class="line">  	<span class="comment">//这个节点的property属性，对应POJO的属性</span></span><br><span class="line">    <span class="keyword">private</span> String property;</span><br><span class="line">  	<span class="comment">//这个节点的column属性，对应SQL的列名</span></span><br><span class="line">    <span class="keyword">private</span> String column;</span><br><span class="line">  	<span class="comment">//POJO属性的JavaType，java类型</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; javaType;</span><br><span class="line">  	<span class="comment">//SQL列对应的JDBCType，JDBC类型</span></span><br><span class="line">    <span class="keyword">private</span> JdbcType jdbcType;</span><br><span class="line">  	<span class="comment">//用来处理这个javaType和这个JDBCType的互相转换的类型处理器</span></span><br><span class="line">    <span class="keyword">private</span> TypeHandler&lt;?&gt; typeHandler;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String nestedResultMapId;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String nestedQueryId;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; notNullColumns;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String columnPrefix;</span><br><span class="line">  	<span class="comment">//标志这个列是否为主键、或者是否在`&lt;contructor&gt;`中存在等</span></span><br><span class="line">    <span class="comment">//ResultFlag就是一个简单的枚举类，这没啥可说的</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ResultFlag&gt; flags;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ResultMapping&gt; composites;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String resultSet;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String foreignColumn;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> lazy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么<code>resultMap</code>的存储结构就分析完了，我们继续看源码，从代码清单3.2的28行<code>resultMapElements(context.evalNodes(&quot;/mapper/resultMap&quot;));</code>向下，详细分析<code>resultMap</code>的解析过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.12</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resultMapElements</span><span class="params">(List&lt;XNode&gt; list)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (XNode resultMapNode : list) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resultMapElement(resultMapNode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">            <span class="comment">// ignore, it will be retried</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ResultMap <span class="title">resultMapElement</span><span class="params">(XNode resultMapNode)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> resultMapElement(resultMapNode, Collections.emptyList(), <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ResultMap <span class="title">resultMapElement</span><span class="params">(XNode resultMapNode, </span></span></span><br><span class="line"><span class="function"><span class="params">                                   List&lt;ResultMapping&gt; additionalResultMappings,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   Class&lt;?&gt; enclosingType)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ErrorContext.instance().activity(<span class="string">"processing "</span> +</span><br><span class="line">                                     resultMapNode.getValueBasedIdentifier());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//从&lt;resultMap&gt;节点上读取属性值type</span></span><br><span class="line">    <span class="comment">//若type不存在就寻找ofType，以此类推地寻找resultType和javaType</span></span><br><span class="line">    String type = resultMapNode.getStringAttribute(<span class="string">"type"</span>, </span><br><span class="line">                resultMapNode.getStringAttribute(<span class="string">"ofType"</span>,</span><br><span class="line">                resultMapNode.getStringAttribute(<span class="string">"resultType"</span>,</span><br><span class="line">                resultMapNode.getStringAttribute(<span class="string">"javaType"</span>))));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据找到的type字符串，生成type对应的Class对象</span></span><br><span class="line">    Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">if</span> (typeClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">      typeClass = inheritEnclosingType(resultMapNode, enclosingType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    Discriminator discriminator = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ResultMapping负责存在单个pojo-Sql映射，比如&lt;id&gt;、&lt;result&gt;节点中包含的映射信息</span></span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    resultMappings.addAll(additionalResultMappings);</span><br><span class="line">    List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//遍历这个&lt;resultMap&gt;的所有子节点</span></span><br><span class="line">    <span class="keyword">for</span> (XNode resultChild : resultChildren) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理&lt;constructor&gt;节点</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"constructor"</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">            processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理&lt;discriminator&gt;节点    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"discriminator"</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">            discriminator </span><br><span class="line">                = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理其他节点    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">            List&lt;ResultFlag&gt; flags = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//如果这个节点是&lt;id&gt;，则添加一个主键标志</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"id"</span>.equals(resultChild.getName())) &#123;</span><br><span class="line">                flags.add(ResultFlag.ID);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//&lt;id&gt;、&lt;result&gt;等节点的具体解析过程</span></span><br><span class="line">            resultMappings.</span><br><span class="line">                add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取这个&lt;resultMap&gt;的id属性</span></span><br><span class="line">    String id = resultMapNode.getStringAttribute(<span class="string">"id"</span>,</span><br><span class="line">                resultMapNode.getValueBasedIdentifier());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取这个&lt;resultMap&gt;的extend属性</span></span><br><span class="line">    String extend = resultMapNode.getStringAttribute(<span class="string">"extends"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取这个&lt;resultMap&gt;是否开启自动映射</span></span><br><span class="line">    Boolean autoMapping = resultMapNode.getBooleanAttribute(<span class="string">"autoMapping"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据前面获取的各种信息创建ResultMap解析器</span></span><br><span class="line">    ResultMapResolver resultMapResolver </span><br><span class="line">        = <span class="keyword">new</span> ResultMapResolver(builderAssistant, id, typeClass, extend,</span><br><span class="line">                                discriminator, resultMappings, autoMapping);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//通过这些信息，解析并返回ResultMap对象</span></span><br><span class="line">        <span class="keyword">return</span> resultMapResolver.resolve();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IncompleteElementException  e) &#123;</span><br><span class="line">    	<span class="comment">//如果解析出错了就假如到Configuration的未成功解析列表中</span></span><br><span class="line">        configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述<code>resultMapElement</code>解析过程还是挺复杂的，这里总结一下，它完成的几项工作</p>
<ol>
<li>获取<code>&lt;resultMap&gt;</code>节点的各种属性</li>
<li>解析<code>&lt;resultMap&gt;</code>的所有子节点，并把返回结果存起来</li>
<li>用第1步和第2步获取的信息构造一个<code>ResultMap</code>对象</li>
<li>若第3步构造失败，则添加到未成功解析列表并抛出异常</li>
</ol>
<p>第1步比较简单，大家一看就懂。第2步将在3.2.2.1中展开分析。第3步将在3.2.2.2中展开分析。</p>
<h5 id="3-2-2-1-解析-lt-resultMap-gt-节点中的-lt-id-gt-节点和-lt-result-gt-节点"><a href="#3-2-2-1-解析-lt-resultMap-gt-节点中的-lt-id-gt-节点和-lt-result-gt-节点" class="headerlink" title="3.2.2.1 解析&lt;resultMap&gt;节点中的&lt;id&gt;节点和&lt;result&gt;节点"></a>3.2.2.1 解析<code>&lt;resultMap&gt;</code>节点中的<code>&lt;id&gt;</code>节点和<code>&lt;result&gt;</code>节点</h5><p>本节以<code>&lt;id&gt;</code>节点和<code>&lt;result&gt;</code>节点为例，分析<code>&lt;resultMap&gt;</code>节点的子节点是如何解析的。那我们从代码清单<code>3.12</code>的71行<code>resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</code>向下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.13</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ResultMapping <span class="title">buildResultMappingFromContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    </span><br><span class="line">    String property;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (flags.contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">      	property = context.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	property = context.getStringAttribute(<span class="string">"property"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    String column = context.getStringAttribute(<span class="string">"column"</span>);</span><br><span class="line">    </span><br><span class="line">    String javaType = context.getStringAttribute(<span class="string">"javaType"</span>);</span><br><span class="line">    </span><br><span class="line">    String jdbcType = context.getStringAttribute(<span class="string">"jdbcType"</span>);</span><br><span class="line">    </span><br><span class="line">    String nestedSelect = context.getStringAttribute(<span class="string">"select"</span>);</span><br><span class="line">    </span><br><span class="line">    String nestedResultMap = context.getStringAttribute(<span class="string">"resultMap"</span>,</span><br><span class="line">        processNestedResultMappings(context, Collections.emptyList(), resultType));</span><br><span class="line">    </span><br><span class="line">    String notNullColumn = context.getStringAttribute(<span class="string">"notNullColumn"</span>);</span><br><span class="line">    </span><br><span class="line">    String columnPrefix = context.getStringAttribute(<span class="string">"columnPrefix"</span>);</span><br><span class="line">    </span><br><span class="line">    String typeHandler = context.getStringAttribute(<span class="string">"typeHandler"</span>);</span><br><span class="line">    </span><br><span class="line">    String resultSet = context.getStringAttribute(<span class="string">"resultSet"</span>);</span><br><span class="line">    </span><br><span class="line">    String foreignColumn = context.getStringAttribute(<span class="string">"foreignColumn"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">boolean</span> lazy = <span class="string">"lazy"</span>.equals(</span><br><span class="line">        context.getStringAttribute(</span><br><span class="line">            <span class="string">"fetchType"</span>, configuration.isLazyLoadingEnabled() ? <span class="string">"lazy"</span> : <span class="string">"eager"</span>));</span><br><span class="line">    </span><br><span class="line">    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">    </span><br><span class="line">    Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = resolveClass(typeHandler);</span><br><span class="line">    </span><br><span class="line">    JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> builderAssistant.buildResultMapping(</span><br><span class="line">        resultType,</span><br><span class="line">        property,</span><br><span class="line">        column,</span><br><span class="line">        javaTypeClass,</span><br><span class="line">        jdbcTypeEnum,</span><br><span class="line">        nestedSelect,</span><br><span class="line">        nestedResultMap,</span><br><span class="line">        notNullColumn,</span><br><span class="line">        columnPrefix,</span><br><span class="line">        typeHandlerClass,</span><br><span class="line">        flags,</span><br><span class="line">        resultSet,</span><br><span class="line">        foreignColumn,</span><br><span class="line">        lazy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法实在乏善可陈，它只是从<code>&lt;result&gt;</code>或者<code>&lt;id&gt;</code>节点上获取了各种属性，然后将这些获取到的属性统统传递给<code>builderAssistant.buildResultMapping()</code>，然后这个助手类完成真正的解析工作并返回<code>ResultMapping</code>对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.13</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder;</span></span><br><span class="line"><span class="comment">//MapperBuilderAssistant</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultMapping <span class="title">buildResultMapping</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;?&gt; resultType,</span></span></span><br><span class="line"><span class="function"><span class="params">      String property,</span></span></span><br><span class="line"><span class="function"><span class="params">      String column,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;?&gt; javaType,</span></span></span><br><span class="line"><span class="function"><span class="params">      JdbcType jdbcType,</span></span></span><br><span class="line"><span class="function"><span class="params">      String nestedSelect,</span></span></span><br><span class="line"><span class="function"><span class="params">      String nestedResultMap,</span></span></span><br><span class="line"><span class="function"><span class="params">      String notNullColumn,</span></span></span><br><span class="line"><span class="function"><span class="params">      String columnPrefix,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">      List&lt;ResultFlag&gt; flags,</span></span></span><br><span class="line"><span class="function"><span class="params">      String resultSet,</span></span></span><br><span class="line"><span class="function"><span class="params">      String foreignColumn,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> lazy)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    Class&lt;?&gt; javaTypeClass = </span><br><span class="line">        resolveResultJavaType(resultType, property, javaType);</span><br><span class="line">    </span><br><span class="line">    TypeHandler&lt;?&gt; typeHandlerInstance = </span><br><span class="line">        resolveTypeHandler(javaTypeClass, typeHandler);</span><br><span class="line">    </span><br><span class="line">    List&lt;ResultMapping&gt; composites = parseCompositeColumnName(column);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResultMapping.Builder(configuration, property, column, javaTypeClass)</span><br><span class="line">        .jdbcType(jdbcType)</span><br><span class="line">        .nestedQueryId(applyCurrentNamespace(nestedSelect, <span class="keyword">true</span>))</span><br><span class="line">        .nestedResultMapId(applyCurrentNamespace(nestedResultMap, <span class="keyword">true</span>))</span><br><span class="line">        .resultSet(resultSet)</span><br><span class="line">        .typeHandler(typeHandlerInstance)</span><br><span class="line">        .flags(flags == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;&gt;() : flags)</span><br><span class="line">        .composites(composites)</span><br><span class="line">        .notNullColumns(parseMultipleColumnNames(notNullColumn))</span><br><span class="line">        .columnPrefix(columnPrefix)</span><br><span class="line">        .foreignColumn(foreignColumn)</span><br><span class="line">        .lazy(lazy)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于这个<code>ResultMapping.Builder</code>就不继续深入了，它是一个简单的建造者负责建造<code>ResultMapping</code>。其实就是通过各种方法调用，为<code>ResultMapping</code>的实例设置属性而已。设置完成后，调用<code>build()</code>直接返回这个实例。</p>
<p>下面总结一下，对于<code>&lt;id&gt;</code>和<code>&lt;result&gt;</code>这种代表单个POJO-SQL映射的标签，MyBatis会将标签携带的属性进行解析，并全部存放在一个<code>ResultMapping</code>实例中返回。</p>
<h5 id="3-2-2-2-构建ResultMap对象的过程"><a href="#3-2-2-2-构建ResultMap对象的过程" class="headerlink" title="3.2.2.2 构建ResultMap对象的过程"></a>3.2.2.2 构建<code>ResultMap</code>对象的过程</h5><p>我们从代码清单<code>3.12</code>的93行<code>return resultMapResolver.resolve();</code>，看看这个解析器是如何构建<code>ResultMap</code>的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.13</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder;</span></span><br><span class="line"><span class="comment">//ResultMapResolver</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultMap <span class="title">resolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> assistant.addResultMap(<span class="keyword">this</span>.id,</span><br><span class="line">                                  <span class="keyword">this</span>.type,</span><br><span class="line">                                  <span class="keyword">this</span>.extend,</span><br><span class="line">                                  <span class="keyword">this</span>.discriminator,</span><br><span class="line">                                  <span class="keyword">this</span>.resultMappings,</span><br><span class="line">                                  <span class="keyword">this</span>.autoMapping);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码清单<code>3.13</code>实际上调用了建造器助手的<code>addResultMap</code>方法，我们继续向下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.14</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder;</span></span><br><span class="line"><span class="comment">//MapperBuilderAssistant</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultMap <span class="title">addResultMap</span><span class="params">(String id,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Class&lt;?&gt; type,</span></span></span><br><span class="line"><span class="function"><span class="params">                              String extend,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Discriminator discriminator,</span></span></span><br><span class="line"><span class="function"><span class="params">                              List&lt;ResultMapping&gt; resultMappings,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Boolean autoMapping)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    id = applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    extend = applyCurrentNamespace(extend, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理继承情况，不展开了</span></span><br><span class="line">    <span class="keyword">if</span> (extend != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!configuration.hasResultMap(extend)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(</span><br><span class="line">                <span class="string">"Could not find a parent resultmap with id '"</span> </span><br><span class="line">                + extend + <span class="string">"'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ResultMap resultMap </span><br><span class="line">            = configuration.getResultMap(extend);</span><br><span class="line">        </span><br><span class="line">        List&lt;ResultMapping&gt; extendedResultMappings </span><br><span class="line">            = <span class="keyword">new</span> ArrayList&lt;&gt;(resultMap.getResultMappings());</span><br><span class="line">        </span><br><span class="line">        extendedResultMappings.removeAll(resultMappings);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Remove parent constructor if this resultMap declares a constructor.</span></span><br><span class="line">        <span class="keyword">boolean</span> declaresConstructor = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (ResultMapping resultMapping : resultMappings) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">                declaresConstructor = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (declaresConstructor) &#123;</span><br><span class="line">            extendedResultMappings.removeIf(</span><br><span class="line">                resultMapping -&gt; resultMapping.</span><br><span class="line">				getFlags().contains(ResultFlag.CONSTRUCTOR)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        resultMappings.addAll(extendedResultMappings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用建造者构造ResultMap</span></span><br><span class="line">    ResultMap resultMap = </span><br><span class="line">        <span class="keyword">new</span> ResultMap.Builder(configuration,</span><br><span class="line">                              id,</span><br><span class="line">                              type,</span><br><span class="line">                              resultMappings,</span><br><span class="line">                              autoMapping)</span><br><span class="line">      						.discriminator(discriminator)</span><br><span class="line">      						.build();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将得到的ResultMap保存到configuration的resultMaps中</span></span><br><span class="line">    configuration.addResultMap(resultMap);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法实际上做了这几件事</p>
<ol>
<li>处理<code>resultMap</code>的继承(<code>extend</code>属性)</li>
<li>通过<code>ResultMap</code>的建造者构造<code>ResultMap</code>实例</li>
<li>将这个<code>ResultMap</code>实例保存到<code>configuration</code>的<code>resultMaps</code>中</li>
</ol>
<p>下面我们继续看看这个建造者是怎么完成建造工作的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.15</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//ResultMap.Builder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultMap <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果这个resultMap没有id，也就是唯一标识符，直接报错</span></span><br><span class="line">    <span class="keyword">if</span> (resultMap.id == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"ResultMaps must have an id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//把这个resultMap需要使用但没有传入的List和Set初始化</span></span><br><span class="line">    resultMap.mappedColumns = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    resultMap.mappedProperties = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    resultMap.idResultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    resultMap.constructorResultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    resultMap.propertyResultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化构造器参数名列表</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; constructorArgNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//遍历所有Mapping</span></span><br><span class="line">    <span class="keyword">for</span> (ResultMapping resultMapping : resultMap.resultMappings) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//设置&lt;association&gt;和&lt;collection&gt;标记</span></span><br><span class="line">        resultMap.hasNestedQueries = </span><br><span class="line">            resultMap.hasNestedQueries || resultMapping.getNestedQueryId() != <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//同上</span></span><br><span class="line">        resultMap.hasNestedResultMaps = </span><br><span class="line">            resultMap.hasNestedResultMaps ||</span><br><span class="line">            (resultMapping.getNestedResultMapId() != <span class="keyword">null</span></span><br><span class="line">             &amp;&amp; resultMapping.getResultSet() == <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取SQL列名</span></span><br><span class="line">        <span class="keyword">final</span> String column = resultMapping.getColumn();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将列名加入mappedColumns集合</span></span><br><span class="line">        <span class="comment">//列名不为空的情况</span></span><br><span class="line">        <span class="keyword">if</span> (column != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resultMap.mappedColumns.add(column.toUpperCase(Locale.ENGLISH));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//Mapping是复合结构的情况</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultMapping.isCompositeResult()) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (ResultMapping compositeResultMapping :</span><br><span class="line">                 resultMapping.getComposites())&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">final</span> String compositeColumn = compositeResultMapping.getColumn();</span><br><span class="line">                <span class="keyword">if</span> (compositeColumn != <span class="keyword">null</span>) &#123;</span><br><span class="line">               		resultMap.mappedColumns.</span><br><span class="line">                        add(compositeColumn.toUpperCase(Locale.ENGLISH));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      	</span><br><span class="line">        <span class="comment">//获取POJO属性名</span></span><br><span class="line">        <span class="keyword">final</span> String property = resultMapping.getProperty();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//将属性名加入mappedProperties集合</span></span><br><span class="line">        <span class="keyword">if</span> (property != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resultMap.mappedProperties.add(property);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">//将带有构造器标记的mapping加入constructorResultMappings列表</span></span><br><span class="line">        <span class="keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">            resultMap.constructorResultMappings.add(resultMapping);</span><br><span class="line">            <span class="keyword">if</span> (resultMapping.getProperty() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                constructorArgNames.add(resultMapping.getProperty());</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将不带构造器标记的mapping加入propertyResultMappings列表  </span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultMap.propertyResultMappings.add(resultMapping);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将带有主键标记的mapping加入idResultMappings列表</span></span><br><span class="line">        <span class="keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.ID)) &#123;</span><br><span class="line">            resultMap.idResultMappings.add(resultMapping);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果这个resultMap没有主键，就让所有人做主键</span></span><br><span class="line">    <span class="keyword">if</span> (resultMap.idResultMappings.isEmpty()) &#123;</span><br><span class="line">        resultMap.idResultMappings.addAll(resultMap.resultMappings);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果前面获取的参数名列表不为空，则通过反射按照这个列表获取参数的实际名列表</span></span><br><span class="line">    <span class="comment">//并按照获取的参数实际名称列表对constructorResultMappings进行排序(也就是传参要按顺序)</span></span><br><span class="line">    <span class="keyword">if</span> (!constructorArgNames.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;String&gt; actualArgNames = </span><br><span class="line">            argNamesOfMatchingConstructor(constructorArgNames);</span><br><span class="line">        <span class="keyword">if</span> (actualArgNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error in result map '"</span> + resultMap.id</span><br><span class="line">                + <span class="string">"'. Failed to find a constructor in '"</span></span><br><span class="line">                + resultMap.getType().getName() + <span class="string">"' by arg names "</span> </span><br><span class="line">                + constructorArgNames</span><br><span class="line">                + <span class="string">". There might be more info in debug log."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        resultMap.constructorResultMappings.sort((o1, o2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> paramIdx1 = actualArgNames.indexOf(o1.getProperty());</span><br><span class="line">            <span class="keyword">int</span> paramIdx2 = actualArgNames.indexOf(o2.getProperty());</span><br><span class="line">            <span class="keyword">return</span> paramIdx1 - paramIdx2;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将resultMappings等一干集合类冻结为不能修改的状态</span></span><br><span class="line">    <span class="comment">// lock down collections</span></span><br><span class="line">    resultMap.resultMappings </span><br><span class="line">        = Collections.unmodifiableList(resultMap.resultMappings);</span><br><span class="line">    resultMap.idResultMappings </span><br><span class="line">        = Collections.unmodifiableList(resultMap.idResultMappings);</span><br><span class="line">    resultMap.constructorResultMappings </span><br><span class="line">        = Collections.unmodifiableList(resultMap.constructorResultMappings);</span><br><span class="line">    resultMap.propertyResultMappings </span><br><span class="line">        = Collections.unmodifiableList(resultMap.propertyResultMappings);</span><br><span class="line">    resultMap.mappedColumns </span><br><span class="line">        = Collections.unmodifiableSet(resultMap.mappedColumns);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码比较长，但实际上就如代码清单<code>3.10</code>所示，它将传入的<code>resultMappings</code>列表中的元素，按照不同的特点放入了不同的列表和集合中，仅此而已。</p>
<p>到此，我们就完成了<code>ResultMap</code>对象的构建，并且将构建完的结果以<code>id</code>做键、<code>ResultMap</code>做值的形式存放到了configuration的<code>resultMaps</code>映射中。本节比较值得学习的就是MyBatis对于建造者模式的使用。</p>
<h4 id="3-2-3-解析-lt-sql-gt-节点"><a href="#3-2-3-解析-lt-sql-gt-节点" class="headerlink" title="3.2.3 解析&lt;sql&gt;节点"></a>3.2.3 解析<code>&lt;sql&gt;</code>节点</h4><p><code>&lt;sql&gt;</code>节点用来定义一些可重用的SQL语句片段，比如表名，或表的列名等。在映射文件中，我们可以通过 <code>&lt;include&gt;</code>节点引用<code>&lt;sql&gt;</code>节点定义的内容。</p>
<p>在分析源码之前，先来演示一下<code>&lt;sql&gt;</code>节点的使用方式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--id:3.16--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">	article</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findOne"</span> <span class="attr">resultType</span>=<span class="string">"Article"</span>&gt;</span></span><br><span class="line">	SELECT id, title </span><br><span class="line">    FROM <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"table"</span>/&gt;</span> </span><br><span class="line">    WHERE id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"Article"</span>&gt;</span></span><br><span class="line">	UPDATE <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"table"</span>/&gt;</span> </span><br><span class="line">    SET title = #&#123;title&#125; </span><br><span class="line">    WHERE id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后，我们从代码清单<code>3.2</code>的32行<code>sqlElement(context.evalNodes(&quot;/mapper/sql&quot;));</code>继续向下，看看对于<code>&lt;sql&gt;</code>节点的解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.17</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//用于存放解析完毕的&lt;sql&gt;节点，从configuration中取得的</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, XNode&gt; sqlFragments;</span><br><span class="line"></span><br><span class="line"><span class="comment">//代码清单3.2的32行调用此方法</span></span><br><span class="line"><span class="comment">//它先解析所有databaseId与当前数据库匹配的&lt;sql&gt;节点</span></span><br><span class="line"><span class="comment">//然后解析所有不带databaseId的&lt;sql&gt;节点</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sqlElement</span><span class="params">(List&lt;XNode&gt; list)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sqlElement(list, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    sqlElement(list, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sqlElement</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//遍历所有&lt;sql&gt;节点</span></span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取databaseId</span></span><br><span class="line">        String databaseId = context.getStringAttribute(<span class="string">"databaseId"</span>);</span><br><span class="line">        <span class="comment">//获取这个&lt;sql&gt;节点的id属性</span></span><br><span class="line">        String id = context.getStringAttribute(<span class="string">"id"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//在这个id属性的前面加上当前的命名空间</span></span><br><span class="line">        <span class="comment">//例如:table -&gt; com.edu.neu.zady.dao.ProductDao.table</span></span><br><span class="line">        id = builderAssistant.applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果数据库id符合，则将这个&lt;sql&gt;节点直接添加到sqlFragment映射中</span></span><br><span class="line">        <span class="keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;</span><br><span class="line">            sqlFragments.put(id, context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>&lt;sql&gt;</code>节点的解析非常简单，它只不过是完成了以下几件事</p>
<ol>
<li><p>通过<code>databaseId</code>筛选符合当前数据库的<code>&lt;sql&gt;</code>节点</p>
</li>
<li><p>将符合要求的节点加入<code>sqlFragment</code>映射，这个映射将在解析SQL语句节点时使用</p>
</li>
</ol>
<p>并且，其实这个<code>sqlFragement</code>也是存储在<code>Configuration</code>中的，方便后面的使用。</p>
<h4 id="3-2-4-解析SQL语句节点"><a href="#3-2-4-解析SQL语句节点" class="headerlink" title="3.2.4 解析SQL语句节点"></a>3.2.4 解析SQL语句节点</h4><p>下面是本章的重头戏，<code>&lt;select&gt;</code>、<code>&lt;insert&gt;</code>、<code>&lt;update&gt;</code>、<code>&lt;delete&gt;</code>等SQL语句节点的解析。这些节点的用处都是存储SQL语句，所以解析过程是相同的。</p>
<p>在分析之前，我们还是先看看在<code>Configuration</code>中解析完的信息是怎么储存的。对于每个SQL语句节点，MyBatis都会解析成一个<code>MappedStatement</code>的实例。然后在<code>Configuration</code>中，是通过以<code>id</code>为键，以<code>MappedStatement</code>本身为值存储在了一个<code>Map</code>中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, MappedStatement&gt; mappedStatements </span><br><span class="line">    = <span class="keyword">new</span> StrictMap&lt;MappedStatement&gt;(<span class="string">"Mapped Statements collection"</span>);</span><br></pre></td></tr></table></figure>
<p>接下来我们看看，上面提到的<code>MappedStatement</code>都存储了那些信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.18</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//MappedStatement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MappedStatement</span> </span>&#123;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String resource;</span><br><span class="line">    <span class="comment">//一个Configuration的引用</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> Integer fetchSize;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> Integer timeout;</span><br><span class="line">    <span class="comment">//STATEMENT, PREPARED, CALLABLE</span></span><br><span class="line">    <span class="keyword">private</span> StatementType statementType;</span><br><span class="line">    <span class="comment">//DEFAULT, FORWARD_ONLY, SCROLL_INSENSITIVE, SCROLL_SENSITIVE;</span></span><br><span class="line">    <span class="keyword">private</span> ResultSetType resultSetType;</span><br><span class="line">    <span class="comment">//存放具体的SQL语句，还有参数列表等</span></span><br><span class="line">    <span class="keyword">private</span> SqlSource sqlSource;</span><br><span class="line">    <span class="comment">//这个Statement使用的二级缓存</span></span><br><span class="line">    <span class="keyword">private</span> Cache cache;</span><br><span class="line">    <span class="comment">//存放使用的参数</span></span><br><span class="line">    <span class="keyword">private</span> ParameterMap parameterMap;</span><br><span class="line">    <span class="comment">//存放使用的一些ResultMap</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ResultMap&gt; resultMaps;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flushCacheRequired;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> useCache;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> resultOrdered;</span><br><span class="line">    <span class="comment">//UNKNOWN, INSERT, UPDATE, DELETE, SELECT, FLUSH</span></span><br><span class="line">    <span class="keyword">private</span> SqlCommandType sqlCommandType;</span><br><span class="line">    <span class="comment">//用来自增主键</span></span><br><span class="line">    <span class="keyword">private</span> KeyGenerator keyGenerator;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String[] keyProperties;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String[] keyColumns;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> hasNestedResultMaps;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String databaseId;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> Log statementLog;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> LanguageDriver lang;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> String[] resultSets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们详细展开上一个代码清单的20行<code>private SqlSource sqlSource;</code>看看<code>SqlSource</code>是什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.18</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//SqlSource</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SqlSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">BoundSql <span class="title">getBoundSql</span><span class="params">(Object parameterObject)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它是个接口，这个接口传入<code>parameter</code>，然后返回一个<code>BoundSql</code>实例。那我们接着看看<code>BoundSql</code>的结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.19</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.mapping;</span></span><br><span class="line"><span class="comment">//BoundSql</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoundSql</span> </span>&#123;</span><br><span class="line">	<span class="comment">//真.SQL语句</span></span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">final</span> String sql;</span><br><span class="line">  	<span class="comment">//参数的列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ParameterMapping&gt; parameterMappings;</span><br><span class="line">  	<span class="comment">//略</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object parameterObject;</span><br><span class="line">  	<span class="comment">//额外参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; additionalParameters;</span><br><span class="line">  	<span class="comment">//参数的元数据信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MetaObject metaParameters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，和SQL语句有关的存储结构算是分析完了。</p>
<p>我们下面从代码清单<code>3.2</code>的34行<code>buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</code>继续向下，看看<code>MappedStatement</code>是怎么构建的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.20</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (configuration.getDatabaseId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      buildStatementFromContext(list, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    buildStatementFromContext(list, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//遍历每个&lt;select|insert|update|delete&gt;节点</span></span><br><span class="line">    <span class="keyword">for</span> (XNode context : list) &#123;</span><br><span class="line">        <span class="keyword">final</span> XMLStatementBuilder statementParser = </span><br><span class="line">            <span class="keyword">new</span> XMLStatementBuilder(configuration,</span><br><span class="line">                                    builderAssistant,</span><br><span class="line">                                    context,</span><br><span class="line">                                    requiredDatabaseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//每个节点的实际解析逻辑</span></span><br><span class="line">            statementParser.parseStatementNode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</span><br><span class="line">            configuration.addIncompleteStatement(statementParser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法其实什么也没干，它制作遍历每个节点，然后把具体每个节点的解析交给<code>XMLstatementBuilder</code>的<code>parseStatementNode()</code>来处理，具体的解析逻辑都在这个方法里，那我们继续向下看看这个方法。</p>
<p>在看源码之前，先大体描述这个方法进行的几步操作</p>
<ol>
<li>解析SQL语句中的<code>&lt;include&gt;</code>节点，第34行</li>
<li>解析SQL语句中的<code>&lt;selectKey&gt;</code>节点，第46行</li>
<li>解析SQL语句， 第67行</li>
<li>构建<code>MappedStatement</code>，第93行</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.20</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLStatementBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseStatementNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取&lt;select|insert|update|delete&gt;节点的id</span></span><br><span class="line">    String id = context.getStringAttribute(<span class="string">"id"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取&lt;select|insert|update|delete&gt;节点的dataBaseId</span></span><br><span class="line">    String databaseId = context.getStringAttribute(<span class="string">"databaseId"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果dataBaseId与当前数据库不匹配，则不解析这个节点，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="keyword">this</span>.requiredDatabaseId)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取这个节点的名称，select、insert、update还是delete</span></span><br><span class="line">    String nodeName = context.getNode().getNodeName();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过节点的名称创建一个SqlCommandType</span></span><br><span class="line">    SqlCommandType sqlCommandType </span><br><span class="line">        = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据节点的属性来设置一些标志位</span></span><br><span class="line">    <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">    <span class="keyword">boolean</span> flushCache = context.getBooleanAttribute(<span class="string">"flushCache"</span>, !isSelect);</span><br><span class="line">    <span class="keyword">boolean</span> useCache = context.getBooleanAttribute(<span class="string">"useCache"</span>, isSelect);</span><br><span class="line">    <span class="keyword">boolean</span> resultOrdered = context.getBooleanAttribute(<span class="string">"resultOrdered"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析SQL语句中的&lt;include&gt;节点</span></span><br><span class="line">    <span class="comment">//例如代码清单3.16的第8行、第13行</span></span><br><span class="line">    <span class="comment">// Include Fragments before parsing</span></span><br><span class="line">    XMLIncludeTransformer includeParser </span><br><span class="line">        = <span class="keyword">new</span> XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//同上</span></span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取节点的parameterType属性</span></span><br><span class="line">    String parameterType = context.getStringAttribute(<span class="string">"parameterType"</span>);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取节点的语言属性</span></span><br><span class="line">    String lang = context.getStringAttribute(<span class="string">"lang"</span>);</span><br><span class="line">    LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析&lt;selectKey&gt;节点</span></span><br><span class="line">    <span class="comment">// Parse selectKey after includes and remove them.</span></span><br><span class="line">    processSelectKeyNodes(id, parameterTypeClass, langDriver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span></span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据命名空间等信息，为这个Statement(也就是这个&lt;select|update|delete|insert&gt;节点)起名</span></span><br><span class="line">    String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="keyword">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理id重名的情况</span></span><br><span class="line">    <span class="keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">      keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      keyGenerator = </span><br><span class="line">          context.getBooleanAttribute(<span class="string">"useGeneratedKeys"</span>,</span><br><span class="line">          configuration.isUseGeneratedKeys() &amp;&amp;</span><br><span class="line">                                      SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">          ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成sqlSource</span></span><br><span class="line">    SqlSource sqlSource =</span><br><span class="line">        langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//生成statementType，比如:Statement、PreparedStatement、CallableStatement</span></span><br><span class="line">    StatementType statementType =</span><br><span class="line">        StatementType.valueOf(context.getStringAttribute(</span><br><span class="line">            <span class="string">"statementType"</span>, StatementType.PREPARED.toString()));</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">//继续获取一些属性 </span></span><br><span class="line">    Integer fetchSize = context.getIntAttribute(<span class="string">"fetchSize"</span>);</span><br><span class="line">    Integer timeout = context.getIntAttribute(<span class="string">"timeout"</span>);</span><br><span class="line">    String parameterMap = context.getStringAttribute(<span class="string">"parameterMap"</span>);</span><br><span class="line">    String resultType = context.getStringAttribute(<span class="string">"resultType"</span>);</span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    String resultMap = context.getStringAttribute(<span class="string">"resultMap"</span>);</span><br><span class="line">    String resultSetType = context.getStringAttribute(<span class="string">"resultSetType"</span>);</span><br><span class="line">    ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line">    String keyProperty = context.getStringAttribute(<span class="string">"keyProperty"</span>);</span><br><span class="line">    String keyColumn = context.getStringAttribute(<span class="string">"keyColumn"</span>);</span><br><span class="line">    String resultSets = context.getStringAttribute(<span class="string">"resultSets"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将前面获取的各种信息，全都传递给builderAssistant.addMappedStatement方法，</span></span><br><span class="line">    <span class="comment">//这个方法将完成MappedStatement的生成操作，并添加到Configuration中</span></span><br><span class="line">    builderAssistant.addMappedStatement(</span><br><span class="line">        id,</span><br><span class="line">        sqlSource,</span><br><span class="line">        statementType,</span><br><span class="line">        sqlCommandType,</span><br><span class="line">        fetchSize,</span><br><span class="line">        timeout,</span><br><span class="line">        parameterMap,</span><br><span class="line">        parameterTypeClass,</span><br><span class="line">        resultMap,</span><br><span class="line">        resultTypeClass,</span><br><span class="line">        resultSetTypeEnum,</span><br><span class="line">        flushCache,</span><br><span class="line">        useCache, </span><br><span class="line">        resultOrdered,</span><br><span class="line">        keyGenerator,</span><br><span class="line">        keyProperty,</span><br><span class="line">        keyColumn,</span><br><span class="line">        databaseId,</span><br><span class="line">        langDriver,</span><br><span class="line">        resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面的4小节，将分别展开这四个步骤</p>
<h5 id="3-2-4-1-解析-lt-include-gt-节点"><a href="#3-2-4-1-解析-lt-include-gt-节点" class="headerlink" title="3.2.4.1 解析&lt;include&gt;节点"></a>3.2.4.1 解析<code>&lt;include&gt;</code>节点</h5><p>注：下面的解析过程比较难，看不懂可以先看后面的例子。如果实在看不懂，这里讲一下这方法执行后的结果。它将<code>XNODE</code>树上的<code>&lt;include&gt;</code>节点替换成了包含对应<code>sql</code>语句的普通文本节点。也就是说，经过这一步的处理，<code>&lt;include&gt;</code>节点在<code>XNODE</code>树中消失了。我们在<code>mapper</code>文件的层次上举个不太恰切的例子。</p>
<p>在没进行解析时，<code>XNODE</code>树是这样的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--id:3.21--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"xyz.coolblog.dao.ArticleDao"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">		$&#123;table_name&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findOne"</span> <span class="attr">resultType</span>=<span class="string">"xyz.coolblog.dao.Article"</span>&gt;</span></span><br><span class="line">		SELECT id, title</span><br><span class="line">		FROM </span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"table_name"</span> <span class="attr">value</span>=<span class="string">"article"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">		WHERE id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>完成解析之后，它变成了一个再普通不过的sql</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--id:3.22--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"xyz.coolblog.dao.ArticleDao"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">		$&#123;table_name&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findOne"</span> <span class="attr">resultType</span>=<span class="string">"xyz.coolblog.dao.Article"</span>&gt;</span></span><br><span class="line">		SELECT id, title</span><br><span class="line">		FROM article</span><br><span class="line">		WHERE id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只不过上面的解析，不是在mapper文件的层面上进行的，而是在<code>XNODE</code>的层面进行的。大家体会理解意思即可。</p>
<p>然后我们从代码清单<code>3.20</code>第37行<code>includeParser.applyIncludes(context.getNode());</code>向下，看看<code>&lt;include&gt;</code>节点的解析过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.21</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLIncludeTransformer</span></span><br><span class="line"><span class="comment">//这个方法不要按顺序读，看不懂先看看后面的例子</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyIncludes</span><span class="params">(Node source, </span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> Properties variablesContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span> included)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//第一个分支，用于处理&lt;include&gt;节点</span></span><br><span class="line">    <span class="keyword">if</span> (source.getNodeName().equals(<span class="string">"include"</span>)) &#123;</span><br><span class="line">    	<span class="comment">//获取&lt;sql&gt;节点，如果refid中包含属性占位符$&#123;&#125;</span></span><br><span class="line">        <span class="comment">//则需先将属性占位符替换为对应的属性</span></span><br><span class="line">        Node toInclude =</span><br><span class="line">            findSqlFragment(getStringAttribute(source, <span class="string">"refid"</span>), variablesContext);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获得&lt;include&gt;节点的所有&lt;property&gt;子节点，并将结果与variablesContext混合</span></span><br><span class="line">        Properties toIncludeContext = getVariablesContext(source, variablesContext);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//递归调用，对&lt;sql&gt;节点执行applyIncludes，替换其中的$&#123;&#125;</span></span><br><span class="line">        applyIncludes(toInclude, toIncludeContext, <span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理&lt;sql&gt;节点在其他文件的情况</span></span><br><span class="line">        <span class="keyword">if</span> (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123;</span><br><span class="line">            toInclude = source.getOwnerDocument().importNode(toInclude, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将&lt;include&gt;节点替换为&lt;sql&gt;节点</span></span><br><span class="line">        source.getParentNode().replaceChild(toInclude, source);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将解析完成的&lt;sql&gt;节点里的Text内容插入到&lt;sql&gt;节点之前</span></span><br><span class="line">        <span class="keyword">while</span> (toInclude.hasChildNodes()) &#123;</span><br><span class="line">            toInclude.getParentNode().</span><br><span class="line">                insertBefore(toInclude.getFirstChild(), toInclude);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//前面插入的Text内容节点是解析好的，已经可以完全代替&lt;sql&gt;节点了</span></span><br><span class="line">        <span class="comment">//那么我们直接将&lt;sql&gt;节点也移除掉</span></span><br><span class="line">        toInclude.getParentNode().removeChild(toInclude);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//第二个条件分支，用来处理&lt;select|insert|update|delete&gt;节点或者&lt;sql&gt;节点</span></span><br><span class="line">    <span class="comment">//总之就是除了&lt;include&gt;节点之外的所有普通节点</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (source.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (included &amp;&amp; !variablesContext.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// replace variables in attribute values</span></span><br><span class="line">        	</span><br><span class="line">            <span class="comment">//获取这个节点的所有属性</span></span><br><span class="line">        	NamedNodeMap attributes = source.getAttributes();</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//遍历这些属性，将属性中的$&#123;&#125;替换为具体的值</span></span><br><span class="line">        	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</span><br><span class="line">          		Node attr = attributes.item(i);</span><br><span class="line">          		attr.setNodeValue(PropertyParser.parse(</span><br><span class="line">                  	attr.getNodeValue(), variablesContext));</span><br><span class="line">        	&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取这个节点的所有子节点</span></span><br><span class="line">        NodeList children = source.getChildNodes();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//对每个子节点执行applyIncludes</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">            applyIncludes(children.item(i), variablesContext, included);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理所有TEXT节点    </span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        included </span><br><span class="line">        &amp;&amp; source.getNodeType() == Node.TEXT_NODE </span><br><span class="line">        &amp;&amp; !variablesContext.isEmpty()) &#123;</span><br><span class="line">      	<span class="comment">// replace variables in text node</span></span><br><span class="line">        <span class="comment">//将节点中的$&#123;&#125;替换为具体的值</span></span><br><span class="line">        source.setNodeValue(</span><br><span class="line">            PropertyParser.parse(</span><br><span class="line">                source.getNodeValue(), variablesContext));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们以代码清单<code>3.21</code>从8-12行的<code>&lt;select&gt;</code>节点的解析为例，详细看看<code>&lt;include&gt;</code>是怎么被替换的。</p>
<p>但是这里还要插入一个先序知识：在<code>XNODE</code>树中，所有的<code>&lt;xxx&gt;</code>标签会被解析为<code>ELEMENT_NODE</code>，而所有<code>&lt;xxx&gt;</code>和<code>&lt;/xxx&gt;</code>间的文本将被解析为<code>TEXT_NODE</code>，除此之外还有<code>ATTRIBUTE_NODE</code>、<code>COMMENT_NODE</code>等很多节点类型，有兴趣可以查看<code>org.w3c.dom.Node</code>接口</p>
<p>那么这个<code>&lt;select&gt;</code>节点的类型为<code>ELEMENT_NODE</code>，它有三个子节点，如下表</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>子节点</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>SELECT id,title FROM</code></td>
<td><code>TEXT_NODE</code></td>
<td>文本节点</td>
</tr>
<tr>
<td>2</td>
<td><code>&lt;include refid=&quot;table&quot;/&gt;</code></td>
<td><code>ELEMENT_NODE</code></td>
<td>普通节点</td>
</tr>
<tr>
<td>3</td>
<td><code>WHERE id= #{id}</code></td>
<td><code>TEXT_NODE</code></td>
<td>文本节点</td>
</tr>
</tbody>
</table>
<p>那么调用的入口代码清单<code>3.20</code>第34行<code>includeParser.applyIncludes(context.getNode());</code>传入的<code>XNode</code>显然是<code>&lt;select&gt;</code>节点。它会进入第二个条件，遍历自己的3个孩子节点。第一个节点和第二个节点的调用栈如下图</p>
<p><img src="https://i.loli.net/2020/03/22/Js3PGbzmCI6yRux.png" alt=""></p>
<p><img src="https://i.loli.net/2020/03/22/pwUle9y8631tfkr.png" alt=""></p>
<h5 id="3-2-4-2-解析-lt-selectKey-gt-节点"><a href="#3-2-4-2-解析-lt-selectKey-gt-节点" class="headerlink" title="3.2.4.2 解析&lt;selectKey&gt;节点"></a>3.2.4.2 解析<code>&lt;selectKey&gt;</code>节点</h5><p>对于一些不支持自增主键的数据库来说，我们在插入数据时，需要明确指定主键数据。例如</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--id:3.22--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"saveAuthor"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">resultType</span>=<span class="string">"int"</span> <span class="attr">order</span>=<span class="string">"BEFORE"</span>&gt;</span></span><br><span class="line">		select author_seq.nextval from dual</span><br><span class="line">	<span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line">	insert into Author</span><br><span class="line">		(id, name, password)</span><br><span class="line">	values</span><br><span class="line">		(#&#123;id&#125;, #&#123;username&#125;, #&#123;password&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这部分的源码就不展开解析了。当Mybatis完成解析后，也会将<code>&lt;selectKey&gt;</code>节点从<code>XNODE</code>树中去掉</p>
<h5 id="3-2-4-3-解析SQL语句生成SqlSource"><a href="#3-2-4-3-解析SQL语句生成SqlSource" class="headerlink" title="3.2.4.3 解析SQL语句生成SqlSource"></a>3.2.4.3 解析SQL语句生成<code>SqlSource</code></h5><p>经过上两节的解析，MyBatis已经把<code>&lt;select|insert|delete|create&gt;</code>中所有的<code>&lt;include&gt;</code>和<code>&lt;selectKey&gt;</code>子孙节点全部都替换并删除掉了。现在<code>XNODE</code>树中只有<code>&lt;if&gt;</code>、<code>&lt;where&gt;</code>等普通的<code>ELEMENT</code>节点和文本节点。这一步，我们将分析MyBatis是如何解析<code>&lt;select|insert|delete|create&gt;</code>节点的<code>XNODE</code>树，来生成<code>SqlSource</code>。当处理用户的实际调用时，MyBatis将通过<code>SqlSource</code>来解析出具体的SQL语句。</p>
<p>我们从代码清单<code>3.20</code> 的70行<code>SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);</code>继续向下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.23</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.scripting.xmltags;</span></span><br><span class="line"><span class="comment">//XMLLanguageDriver</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">createSqlSource</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Configuration configuration,</span></span></span><br><span class="line"><span class="function"><span class="params">    XNode script,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; parameterType)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    XMLScriptBuilder builder </span><br><span class="line">        = <span class="keyword">new</span> XMLScriptBuilder(configuration, script, parameterType);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> builder.parseScriptNode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法，只是通过调用<code>XMLScriptBuilder</code>的<code>parseScriptNode()</code>来实现生成<code>SqlSource</code>的具体逻辑而已，因此我们继续向下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.24</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.scripting.xmltags;</span></span><br><span class="line"><span class="comment">//XMLScriptBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">parseScriptNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//将context这个XNODE的所有子孙节点解析成一个MixedSqlNode（也就是一个SqlNode节点的列表）</span></span><br><span class="line">    <span class="comment">//并且设置isDynamic标志位，来表示这个sqlSource是否需要是动态的</span></span><br><span class="line">    MixedSqlNode rootSqlNode = parseDynamicTags(context);</span><br><span class="line">    </span><br><span class="line">    SqlSource sqlSource;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据是否是动态的创建不同的SqlSource实例</span></span><br><span class="line">    <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">      	sqlSource = <span class="keyword">new</span> DynamicSqlSource(configuration, rootSqlNode);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	sqlSource = <span class="keyword">new</span> RawSqlSource(configuration, rootSqlNode, parameterType);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sqlSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先解释一下什么是动态SQL什么是静态SQL，动态SQL指的包含<code>${}</code>占位符或者<code>&lt;if&gt;</code>、<code>&lt;where&gt;</code>等动态语句节点的SQL。注意：只包含<code>#{}</code>并不算动态SQL。</p>
<p>在继续分析主要逻辑之前，我们先看看<code>MixSqlNode</code>是什么。对于每个<code>XNODE</code>片段，在经过解析后都会变成一个<code>SqlNode</code>节点，比如<code>TEXT</code>节点将被解析为一个<code>StaticTextSqlNode</code>，而<code>&lt;if&gt;</code>节点将被解析为一个<code>IfSqlNode</code>。比较特殊的是<code>MixSqlNode</code>，它存储一个<code>SqlNode</code>类型的列表。类图如下面两张图。</p>
<p><img src="https://i.loli.net/2020/03/24/RwCIX1W248Hht6g.png" alt=""></p>
<p><img src="https://i.loli.net/2020/03/24/oAYu5OQvDWMeGUm.png" alt=""></p>
<p>在大致了解了<code>SqlNode</code>之后，我们从代码清单<code>3.24</code>的第7行继续向下，看看<code>&lt;select|insert|delete|update&gt;</code>这个<code>XNode</code>是怎么被解析为一个<code>MixedSqlNode</code>的。下面源码的逻辑如下</p>
<ol>
<li>遍历<code>&lt;select|insert|delete|update&gt;</code>节点的所有子节点</li>
<li>如果子节点是TEXT类型的，则根据是动态还是静态，解析<code>TextSqlNode</code>或者<code>StaticTextSqlNode</code>，并将解析结果放入<code>contents</code>列表</li>
<li>如果子节点是ELEMENT类型的，那么根据标签名称来选取合适的<code>NodeHandler</code>解析，解析结果也会被放入<code>contents</code>列表</li>
<li>最后通过第2步和第3步得到的<code>contents</code>列表，生成一个<code>MixedSqlNode</code>，并作为<code>SqlNode</code>树的根节点返回</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.25</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.scripting.xmltags;</span></span><br><span class="line"><span class="comment">//XMLScriptBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> MixedSqlNode <span class="title">parseDynamicTags</span><span class="params">(XNode node)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个SqlNode类型的列表，用来存储所有被解析成SqlNode的XNode</span></span><br><span class="line">    List&lt;SqlNode&gt; contents = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取&lt;select|insert|update|delete&gt;节点的各个子SQL节点</span></span><br><span class="line">    NodeList children = node.getNode().getChildNodes();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//遍历所有子节点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">        XNode child = node.newXNode(children.item(i));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1.如果子节点是TEXT类型的</span></span><br><span class="line">        <span class="keyword">if</span> (child.getNode().getNodeType() == Node.CDATA_SECTION_NODE </span><br><span class="line">            || child.getNode().getNodeType() == Node.TEXT_NODE) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//1-1.获取节点中的具体SQL语句</span></span><br><span class="line">            String data = child.getStringBody(<span class="string">""</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//1-2.通过data来创建一个TextSqlNode节点</span></span><br><span class="line">            TextSqlNode textSqlNode = <span class="keyword">new</span> TextSqlNode(data);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//1-3.如果动态，则添加到第2行定义的contents中</span></span><br><span class="line">            <span class="keyword">if</span> (textSqlNode.isDynamic()) &#123;</span><br><span class="line">                contents.add(textSqlNode);</span><br><span class="line">                isDynamic = <span class="keyword">true</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//1-4.如果是静态的，则创建一个StaticTextSqlNode，并放入到contents中    </span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                contents.add(<span class="keyword">new</span> StaticTextSqlNode(data));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">//2.如果子节点是ELEMENT类型的，也就是一&lt;xxx&gt;的节点    </span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getNode().getNodeType() == Node.ELEMENT_NODE) &#123; <span class="comment">// issue #628</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2-1.获取标签的名称，例如:trim、where、if等</span></span><br><span class="line">            String nodeName = child.getNode().getNodeName();</span><br><span class="line">            </span><br><span class="line">           	<span class="comment">//2-2.根据名称获取不同的节点处理器</span></span><br><span class="line">            NodeHandler handler = nodeHandlerMap.get(nodeName);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2-3.处理没有获取到处理器的情况</span></span><br><span class="line">            <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Unknown element &lt;"</span> </span><br><span class="line">                                           + nodeName </span><br><span class="line">                                           + <span class="string">"&gt; in SQL statement."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2-4.调用处理器处理节点</span></span><br><span class="line">            handler.handleNode(child, contents);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2-5.设置为动态</span></span><br><span class="line">            isDynamic = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//它是一个组合型节点，它会按顺序存储一个节点的列表</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MixedSqlNode(contents);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们从上面代码清单的53行<code>handler.handleNode(child, contents);</code>向下，以一个<code>If</code>类型的<code>NodeHandler</code>为例，看看<code>ELEMENT</code>节点是怎么被解析的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.26</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.scripting.xmltags;</span></span><br><span class="line"><span class="comment">//XMLScriptBuilder.IfHandler</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IfHandler</span> <span class="keyword">implements</span> <span class="title">NodeHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IfHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Prevent Synthetic Access</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleNode</span><span class="params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//对它的子节点再次调用parseDynamicTags，来生成一个MixSqlNode(相当于子节点列表)</span></span><br><span class="line">      	MixedSqlNode mixedSqlNode = parseDynamicTags(nodeToHandle);</span><br><span class="line">      	</span><br><span class="line">        <span class="comment">//从&lt;if&gt;节点(XNODE)上获取test属性</span></span><br><span class="line">        String test = nodeToHandle.getStringAttribute(<span class="string">"test"</span>);</span><br><span class="line">      	</span><br><span class="line">        <span class="comment">//创建一个IF类型的SQLNODE节点</span></span><br><span class="line">        IfSqlNode ifSqlNode = <span class="keyword">new</span> IfSqlNode(mixedSqlNode, test);</span><br><span class="line">      	</span><br><span class="line">        <span class="comment">//将这个节点添加到List中，也就是这个节点父节点的子节点列表</span></span><br><span class="line">        targetContents.add(ifSqlNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说，就是对于<code>&lt;select|create|insert|delete&gt;</code>节点来说，它们的所有子节点内容将被解析为一棵节点类型为<code>SqlNode</code>的树，例如下图：这棵树储存在<code>MappedStatement.SqlSource.rootSqlNode</code>中，当运行时，用户调用传入具体参数，MyBatis就可以通过这棵树来生成具体的SQL语句了。至此，我们详细了解了SqlSource的生成过程，以及SqlSource的某些内部存储方式。</p>
<p><img src="https://i.loli.net/2020/03/24/xW2ROFrvbgfpXAl.png" alt=""></p>
<h5 id="3-2-4-4-构建MappedStatement"><a href="#3-2-4-4-构建MappedStatement" class="headerlink" title="3.2.4.4 构建MappedStatement"></a>3.2.4.4 构建<code>MappedStatement</code></h5><p>接着，我们从代码清单<code>3.20</code>的93行<code>builderAssistant.addMappedStatement(xxx)</code>向下，看一下存储SQL语句节点解析结果的<code>MappedStatement</code>是如何构建的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.27</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.scripting.xmltags;</span></span><br><span class="line"><span class="comment">//XMLScriptBuilder.IfHandler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MappedStatement <span class="title">addMappedStatement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    String id,</span></span></span><br><span class="line"><span class="function"><span class="params">    SqlSource sqlSource,</span></span></span><br><span class="line"><span class="function"><span class="params">    StatementType statementType,</span></span></span><br><span class="line"><span class="function"><span class="params">    SqlCommandType sqlCommandType,</span></span></span><br><span class="line"><span class="function"><span class="params">    Integer fetchSize,</span></span></span><br><span class="line"><span class="function"><span class="params">    Integer timeout,</span></span></span><br><span class="line"><span class="function"><span class="params">    String parameterMap,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; parameterType,</span></span></span><br><span class="line"><span class="function"><span class="params">    String resultMap,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;?&gt; resultType,</span></span></span><br><span class="line"><span class="function"><span class="params">    ResultSetType resultSetType,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> flushCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> useCache,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> resultOrdered,</span></span></span><br><span class="line"><span class="function"><span class="params">    KeyGenerator keyGenerator,</span></span></span><br><span class="line"><span class="function"><span class="params">    String keyProperty,</span></span></span><br><span class="line"><span class="function"><span class="params">    String keyColumn,</span></span></span><br><span class="line"><span class="function"><span class="params">    String databaseId,</span></span></span><br><span class="line"><span class="function"><span class="params">    LanguageDriver lang,</span></span></span><br><span class="line"><span class="function"><span class="params">    String resultSets)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理有没有找到的缓存引用的情况</span></span><br><span class="line">    <span class="keyword">if</span> (unresolvedCacheRef) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">"Cache-ref not yet resolved"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//给id加上命名空间做前缀，以保证id的唯一性</span></span><br><span class="line">    id = applyCurrentNamespace(id, <span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这个Sql语句是否为select语句</span></span><br><span class="line">    <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用建造者，并传入很多参数</span></span><br><span class="line">    MappedStatement.Builder statementBuilder </span><br><span class="line">        = <span class="keyword">new</span> MappedStatement.Builder(configuration, id, sqlSource, sqlCommandType)</span><br><span class="line">        .resource(resource)</span><br><span class="line">        .fetchSize(fetchSize)</span><br><span class="line">        .timeout(timeout)</span><br><span class="line">        .statementType(statementType)</span><br><span class="line">        .keyGenerator(keyGenerator)</span><br><span class="line">        .keyProperty(keyProperty)</span><br><span class="line">        .keyColumn(keyColumn)</span><br><span class="line">        .databaseId(databaseId)</span><br><span class="line">        .lang(lang)</span><br><span class="line">        .resultOrdered(resultOrdered)</span><br><span class="line">        .resultSets(resultSets)</span><br><span class="line">        .resultMaps(getStatementResultMaps(resultMap, resultType, id))</span><br><span class="line">        .resultSetType(resultSetType)</span><br><span class="line">        .flushCacheRequired(valueOrDefault(flushCache, !isSelect))</span><br><span class="line">        .useCache(valueOrDefault(useCache, isSelect))</span><br><span class="line">        .cache(currentCache);</span><br><span class="line"></span><br><span class="line">    ParameterMap statementParameterMap </span><br><span class="line">        = getStatementParameterMap(parameterMap, parameterType, id);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (statementParameterMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        statementBuilder.parameterMap(statementParameterMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建造</span></span><br><span class="line">    MappedStatement statement = statementBuilder.build();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将建造好的MappedStatement存储到Configuration中</span></span><br><span class="line">    configuration.addMappedStatement(statement);</span><br><span class="line">    <span class="keyword">return</span> statement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-4-5-总结"><a href="#3-2-4-5-总结" class="headerlink" title="3.2.4.5 总结"></a>3.2.4.5 总结</h5><p>下面总结下本大节的内容。本节主要完成<code>&lt;select|insert|delete|update&gt;</code>节点的解析工作。每一个这类型节点通过解析后都会生成一个<code>MappedStatement</code>实例，储存具体的信息。对于它的<code>&lt;inculde&gt;</code>和<code>&lt;selectKey&gt;</code>子节点，将被解析替换为正常的SQL节点。然后在完成了替换后<code>&lt;inculde&gt;</code>和<code>&lt;selectKey&gt;</code>子节点将被从<code>XNode</code>树中删除。这之后，会解析这个干净的<code>XNode</code>树，每个具体的SQL语句节点将被转义并存储到可以一颗<code>SqlNode</code>类型的树中，在运行时，我们通过解析这棵树将获取具体的SQL语句。然后，我们把<code>MappedStatement</code>节点存储到<code>Configuration</code>中。一个<code>&lt;select|insert|delete|update&gt;</code>节点的解析工作就完成了。</p>
<h3 id="3-3-Mapper接口绑定过程"><a href="#3-3-Mapper接口绑定过程" class="headerlink" title="3.3 Mapper接口绑定过程"></a>3.3 Mapper接口绑定过程</h3><p>当我们完成 了<code>&lt;mapper&gt;</code>文件的解析后，还需要通过绑定，将<code>&lt;mapper&gt;</code>文件中的每个SQL语句节点与java代码中对应<code>mapper</code>接口的对应方法绑定起来，存放到<code>Configuration.MapperRegistry</code>的<code>Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = new HashMap&lt;&gt;();</code>中，它也一个<code>Class</code>对象为键，以<code>MapperProxyFactory</code>为值，这个工厂可以通过反射为给类型的<code>mapper</code>接口生成实例。</p>
<p>这部分也不展开解释了，假如可以看懂第4章的sql执行过程，这个绑定过程也不在话下。</p>
<p>下面的代码是从代码清单<code>3.1</code>的17行<code>bindMapperForNamespace();</code>向下，完成具体的绑定过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.28</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.builder.xml;</span></span><br><span class="line"><span class="comment">//XMLMapperBuilder</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindMapperForNamespace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取这个&lt;mapper&gt;的命名空间</span></span><br><span class="line">    String namespace = builderAssistant.getCurrentNamespace();</span><br><span class="line">    <span class="keyword">if</span> (namespace != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Class&lt;?&gt; boundType = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//通过命名空间找到对应的java类的Class对象</span></span><br><span class="line">            boundType = Resources.classForName(namespace);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">//ignore, bound type is not required</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (boundType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//如果这个java类还没有被解析过</span></span><br><span class="line">            <span class="keyword">if</span> (!configuration.hasMapper(boundType)) &#123;</span><br><span class="line">                <span class="comment">// Spring may not know the real resource name so we set a flag</span></span><br><span class="line">                <span class="comment">// to prevent loading again this resource from the mapper interface</span></span><br><span class="line">                <span class="comment">// look at MapperAnnotationBuilder#loadXmlResource</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//将这个类加入已解析列表</span></span><br><span class="line">                configuration.addLoadedResource(<span class="string">"namespace:"</span> + namespace);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//将解析好的</span></span><br><span class="line">                configuration.addMapper(boundType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们从上述代码清单的26行<code>configuration.addMapper(boundType);</code>向下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id:3.29</span></span><br><span class="line"><span class="comment">//package org.apache.ibatis.binding;</span></span><br><span class="line"><span class="comment">//MapperRegistry</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (type.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasMapper(type)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> </span><br><span class="line">                                       + type </span><br><span class="line">                                       + <span class="string">" is already known to the MapperRegistry."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span> loadCompleted = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            knownMappers.put(type, <span class="keyword">new</span> MapperProxyFactory&lt;&gt;(type));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//下面是用来处理注解的</span></span><br><span class="line">            <span class="comment">// It's important that the type is added before the parser is run</span></span><br><span class="line">            <span class="comment">// otherwise the binding may automatically be attempted by the</span></span><br><span class="line">            <span class="comment">// mapper parser. If the type is already known, it won't try.</span></span><br><span class="line">            MapperAnnotationBuilder parser </span><br><span class="line">                = <span class="keyword">new</span> MapperAnnotationBuilder(config, type);</span><br><span class="line">            parser.parse();</span><br><span class="line">            loadCompleted = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!loadCompleted) &#123;</span><br><span class="line">                knownMappers.remove(type);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MyBatis/" rel="tag"><i class="fa fa-tag"></i> MyBatis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/21/MyBatis源码-2-配置文件的解析过程/" rel="next" title="[MyBatis源码][2][配置文件的解析过程]">
                <i class="fa fa-chevron-left"></i> [MyBatis源码][2][配置文件的解析过程]
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://i.loli.net/2020/03/21/WAKimNUecFR64uo.jpg" alt="T0UGH(GuiPing Wang)">
            
              <p class="site-author-name" itemprop="name">T0UGH(GuiPing Wang)</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">112</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/T0UGH" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="tough.neu.edu@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Friends
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://neusoftware.top/solo" title="ChengYi" target="_blank">ChengYi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mike4ellis.github.io/" title="Mike" target="_blank">Mike</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#第三章-映射文件解析"><span class="nav-number">1.</span> <span class="nav-text">第三章 映射文件解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-映射文件解析入口"><span class="nav-number">1.1.</span> <span class="nav-text">3.1 映射文件解析入口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-解析映射文件"><span class="nav-number">1.2.</span> <span class="nav-text">3.2 解析映射文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-解析-lt-cache-gt-节点"><span class="nav-number">1.2.1.</span> <span class="nav-text">3.2.1 解析&lt;cache&gt;节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-解析-lt-resultMap-gt-节点"><span class="nav-number">1.2.2.</span> <span class="nav-text">3.2.2 解析&lt;resultMap&gt;节点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-2-1-解析-lt-resultMap-gt-节点中的-lt-id-gt-节点和-lt-result-gt-节点"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">3.2.2.1 解析&lt;resultMap&gt;节点中的&lt;id&gt;节点和&lt;result&gt;节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-2-2-构建ResultMap对象的过程"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">3.2.2.2 构建ResultMap对象的过程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-解析-lt-sql-gt-节点"><span class="nav-number">1.2.3.</span> <span class="nav-text">3.2.3 解析&lt;sql&gt;节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-解析SQL语句节点"><span class="nav-number">1.2.4.</span> <span class="nav-text">3.2.4 解析SQL语句节点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-4-1-解析-lt-include-gt-节点"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">3.2.4.1 解析&lt;include&gt;节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-4-2-解析-lt-selectKey-gt-节点"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">3.2.4.2 解析&lt;selectKey&gt;节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-4-3-解析SQL语句生成SqlSource"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">3.2.4.3 解析SQL语句生成SqlSource</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-4-4-构建MappedStatement"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">3.2.4.4 构建MappedStatement</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-4-5-总结"><span class="nav-number">1.2.4.5.</span> <span class="nav-text">3.2.4.5 总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Mapper接口绑定过程"><span class="nav-number">1.3.</span> <span class="nav-text">3.3 Mapper接口绑定过程</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">T0UGH(GuiPing Wang)</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'E1MH6h0YP3yhA0PJsohNBgiT-gzGzoHsz',
        appKey: 'YOiN6zLq3XGfKmlR0b8vyHtN',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  
  


  

  

</body>
</html>
