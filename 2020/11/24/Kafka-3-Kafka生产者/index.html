<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>[Kafka][3][Kafka生产者] | T0UGU BLOG</title>
  <meta name="description" content="第3章 Kafka生产者——向Kafka写入数据  对应代码仓库地址:https://github.com/T0UGH/getting-started-kafka 参考资料: kafka权威指南https://book.douban.com/subject/27665114/ 大数据通用的序列化器——Apache Avrohttps://www.jianshu.com/p/0a85bfbb9f5">
<meta name="keywords" content="大数据,Kafka,消息队列">
<meta property="og:type" content="article">
<meta property="og:title" content="[Kafka][3][Kafka生产者]">
<meta property="og:url" content="https://t0ugh.biz/2020/11/24/Kafka-3-Kafka生产者/index.html">
<meta property="og:site_name" content="打怪升级日常">
<meta property="og:description" content="第3章 Kafka生产者——向Kafka写入数据  对应代码仓库地址:https://github.com/T0UGH/getting-started-kafka 参考资料: kafka权威指南https://book.douban.com/subject/27665114/ 大数据通用的序列化器——Apache Avrohttps://www.jianshu.com/p/0a85bfbb9f5">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://healthlung.oss-cn-beijing.aliyuncs.com/20201123193012.png">
<meta property="og:image" content="https://healthlung.oss-cn-beijing.aliyuncs.com/20201124195244.png">
<meta property="og:image" content="https://healthlung.oss-cn-beijing.aliyuncs.com/20201124201605.png">
<meta property="og:updated_time" content="2020-11-24T12:52:34.790Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[Kafka][3][Kafka生产者]">
<meta name="twitter:description" content="第3章 Kafka生产者——向Kafka写入数据  对应代码仓库地址:https://github.com/T0UGH/getting-started-kafka 参考资料: kafka权威指南https://book.douban.com/subject/27665114/ 大数据通用的序列化器——Apache Avrohttps://www.jianshu.com/p/0a85bfbb9f5">
<meta name="twitter:image" content="https://healthlung.oss-cn-beijing.aliyuncs.com/20201123193012.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://t0ugh.biz/2020/11/24/Kafka-3-Kafka生产者/index.html">
  
    <link rel="alternate" href="/atom.xml" title="打怪升级日常" type="application/atom+xml">
  
  
    <link rel="icon" href="https://i.loli.net/2020/03/21/WAKimNUecFR64uo.jpg" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/t0ugh" target="_blank">
          <img class="img-circle img-rotate" src="https://i.loli.net/2020/03/21/WAKimNUecFR64uo.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">T0UGH</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">学生&amp;编程爱好者</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> ShenYang, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search">
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech="">
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope="" itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/t0ugh" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope="" itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>东北大学软件工程本科在读</p><p>我的邮箱:wang.g.p@foxmail.com</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flink/">Flink</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GitHub/">GitHub</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java并发/">Java并发</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Junit/">Junit</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MyBatis/">MyBatis</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SSM/">SSM</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tensorflow/">Tensorflow</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/vim/">vim</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nlp/">nlp</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务设计/">微服务设计</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/敏捷开发/">敏捷开发</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/流畅的Python/">流畅的Python</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/深度学习/">深度学习</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法导论/">算法导论</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/蓝桥杯/">蓝桥杯</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/">AOP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CNN/">CNN</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/">Flink</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/">GitHub</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GithubFlow/">GithubFlow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JAVA/">JAVA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Junit/">Junit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LSTM/">LSTM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MNIST/">MNIST</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/">MyBatis</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NLP/">NLP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/REST/">REST</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RNN/">RNN</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scrum/">Scrum</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/">SpringBoot</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/">SpringCloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/">SpringMVC</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/">Tensorflow</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YAML/">YAML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aof/">aof</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nlp/">nlp</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rdb/">rdb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中文分词/">中文分词</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/关键词提取/">关键词提取</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分治算法/">分治算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动态规划/">动态规划</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务/">微服务</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务设计/">微服务设计</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序/">排序</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/敏捷原则/">敏捷原则</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/敏捷宣言/">敏捷宣言</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/敏捷开发/">敏捷开发</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库事务/">数据库事务</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机器学习/">机器学习</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/流处理/">流处理</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/深度学习/">深度学习</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/神经网络/">神经网络</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法导论/">算法导论</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/蓝桥杯/">蓝桥杯</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/词性标注/">词性标注</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/贪心算法/">贪心算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/软件测试/">软件测试</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AOP/" style="font-size: 13px;">AOP</a> <a href="/tags/C/" style="font-size: 13.17px;">C++</a> <a href="/tags/CNN/" style="font-size: 13px;">CNN</a> <a href="/tags/Docker/" style="font-size: 13.17px;">Docker</a> <a href="/tags/ES6/" style="font-size: 13px;">ES6</a> <a href="/tags/Flink/" style="font-size: 13.58px;">Flink</a> <a href="/tags/Git/" style="font-size: 13px;">Git</a> <a href="/tags/GitHub/" style="font-size: 13.17px;">GitHub</a> <a href="/tags/GithubFlow/" style="font-size: 13px;">GithubFlow</a> <a href="/tags/JAVA/" style="font-size: 13px;">JAVA</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/JavaScript/" style="font-size: 13.17px;">JavaScript</a> <a href="/tags/Junit/" style="font-size: 13px;">Junit</a> <a href="/tags/Kafka/" style="font-size: 13.08px;">Kafka</a> <a href="/tags/LSTM/" style="font-size: 13px;">LSTM</a> <a href="/tags/MNIST/" style="font-size: 13px;">MNIST</a> <a href="/tags/MongoDB/" style="font-size: 13px;">MongoDB</a> <a href="/tags/MyBatis/" style="font-size: 14px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 13.25px;">MySQL</a> <a href="/tags/NLP/" style="font-size: 13px;">NLP</a> <a href="/tags/Python/" style="font-size: 13.83px;">Python</a> <a href="/tags/REST/" style="font-size: 13px;">REST</a> <a href="/tags/RNN/" style="font-size: 13.08px;">RNN</a> <a href="/tags/Redis/" style="font-size: 13.17px;">Redis</a> <a href="/tags/Scrum/" style="font-size: 13.08px;">Scrum</a> <a href="/tags/Spring/" style="font-size: 13.25px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.58px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 13.08px;">SpringCloud</a> <a href="/tags/SpringMVC/" style="font-size: 13.17px;">SpringMVC</a> <a href="/tags/Tensorflow/" style="font-size: 13.58px;">Tensorflow</a> <a href="/tags/Tomcat/" style="font-size: 13.08px;">Tomcat</a> <a href="/tags/YAML/" style="font-size: 13px;">YAML</a> <a href="/tags/aof/" style="font-size: 13px;">aof</a> <a href="/tags/c/" style="font-size: 13px;">c</a> <a href="/tags/java/" style="font-size: 13.67px;">java</a> <a href="/tags/jvm/" style="font-size: 13.42px;">jvm</a> <a href="/tags/linux/" style="font-size: 13px;">linux</a> <a href="/tags/nlp/" style="font-size: 13.17px;">nlp</a> <a href="/tags/rdb/" style="font-size: 13px;">rdb</a> <a href="/tags/redis/" style="font-size: 13.92px;">redis</a> <a href="/tags/vue/" style="font-size: 13.08px;">vue</a> <a href="/tags/中文分词/" style="font-size: 13px;">中文分词</a> <a href="/tags/关键词提取/" style="font-size: 13px;">关键词提取</a> <a href="/tags/分治算法/" style="font-size: 13px;">分治算法</a> <a href="/tags/动态规划/" style="font-size: 13.17px;">动态规划</a> <a href="/tags/大数据/" style="font-size: 13.75px;">大数据</a> <a href="/tags/并发/" style="font-size: 13.33px;">并发</a> <a href="/tags/微服务/" style="font-size: 13.33px;">微服务</a> <a href="/tags/微服务设计/" style="font-size: 13.33px;">微服务设计</a> <a href="/tags/排序/" style="font-size: 13.17px;">排序</a> <a href="/tags/敏捷原则/" style="font-size: 13px;">敏捷原则</a> <a href="/tags/敏捷宣言/" style="font-size: 13px;">敏捷宣言</a> <a href="/tags/敏捷开发/" style="font-size: 13.25px;">敏捷开发</a> <a href="/tags/数据库事务/" style="font-size: 13.08px;">数据库事务</a> <a href="/tags/数据结构/" style="font-size: 13.33px;">数据结构</a> <a href="/tags/机器学习/" style="font-size: 13.5px;">机器学习</a> <a href="/tags/流处理/" style="font-size: 13.58px;">流处理</a> <a href="/tags/消息队列/" style="font-size: 13.08px;">消息队列</a> <a href="/tags/深度学习/" style="font-size: 13.75px;">深度学习</a> <a href="/tags/神经网络/" style="font-size: 13px;">神经网络</a> <a href="/tags/算法/" style="font-size: 13.08px;">算法</a> <a href="/tags/算法导论/" style="font-size: 13.67px;">算法导论</a> <a href="/tags/蓝桥杯/" style="font-size: 13.08px;">蓝桥杯</a> <a href="/tags/词性标注/" style="font-size: 13px;">词性标注</a> <a href="/tags/贪心算法/" style="font-size: 13px;">贪心算法</a> <a href="/tags/软件测试/" style="font-size: 13px;">软件测试</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">20</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">40</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kafka/">Kafka</a>
              </p>
              <p class="item-title">
                <a href="/2020/11/24/Kafka-3-Kafka生产者/" class="title">[Kafka][3][Kafka生产者]</a>
              </p>
              <p class="item-date">
                <time datetime="2020-11-24T12:52:20.000Z" itemprop="datePublished">2020-11-24</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Kafka/">Kafka</a>
              </p>
              <p class="item-title">
                <a href="/2020/11/22/Kafka-1-初识Kafka/" class="title">[Kafka][1][初识Kafka]</a>
              </p>
              <p class="item-date">
                <time datetime="2020-11-22T09:10:44.000Z" itemprop="datePublished">2020-11-22</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Flink/">Flink</a>
              </p>
              <p class="item-title">
                <a href="/2020/11/18/Flink-8-读写外部系统/" class="title">[Flink][8][读写外部系统]</a>
              </p>
              <p class="item-date">
                <time datetime="2020-11-18T13:07:04.000Z" itemprop="datePublished">2020-11-18</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Flink/">Flink</a>
              </p>
              <p class="item-title">
                <a href="/2020/11/15/Flink-7-有状态算子和应用/" class="title">[Flink][7][有状态算子和应用]</a>
              </p>
              <p class="item-date">
                <time datetime="2020-11-15T10:56:30.000Z" itemprop="datePublished">2020-11-15</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Java并发/">Java并发</a>
              </p>
              <p class="item-title">
                <a href="/2020/11/11/Java并发-5-Java中的锁/" class="title">[Java并发][5][Java中的锁]</a>
              </p>
              <p class="item-date">
                <time datetime="2020-11-11T09:21:10.000Z" itemprop="datePublished">2020-11-11</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
    <article id="post-Kafka-3-Kafka生产者" class="article article-type-post" itemscope="" itemtype="http://schema.org/BlogPosting">
        
            <div class="article-header">
                
                    
  
    <h1 class="article-title" itemprop="name">
      [Kafka][3][Kafka生产者]
    </h1>
  

                        
                            <div class="article-meta">
                                <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/11/24/Kafka-3-Kafka生产者/" class="article-date">
	  <time datetime="2020-11-24T12:52:20.000Z" itemprop="datePublished">2020-11-24</time>
	</a>
</span>
                                    
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Kafka/">Kafka</a>
  </span>

                                        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/Kafka/">Kafka</a>, <a class="article-tag-link" href="/tags/大数据/">大数据</a>, <a class="article-tag-link" href="/tags/消息队列/">消息队列</a>
  </span>


                                            

                                                <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/11/24/Kafka-3-Kafka生产者/#comments" class="article-comment-link">Comments</a></span>
                                                
                            </div>
            </div>
            <div class="article-entry marked-body" itemprop="articleBody">
                
                                    
                                        <div id="toc">
                                            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#第3章-kafka生产者向kafka写入数据"><span class="toc-text"> 第3章 Kafka生产者——向Kafka写入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-生产者概览"><span class="toc-text"> 3.1 生产者概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-创建kafka生产者"><span class="toc-text"> 3.2 创建Kafka生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-发送消息到kafka"><span class="toc-text"> 3.3 发送消息到Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#331-发送并忘记"><span class="toc-text"> 3.3.1 发送并忘记</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#332-同步发送"><span class="toc-text"> 3.3.2 同步发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#333-异步发送"><span class="toc-text"> 3.3.3 异步发送</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-生产者的配置"><span class="toc-text"> 3.4 生产者的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#341-acks"><span class="toc-text"> 3.4.1 acks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#342-retries重试次数"><span class="toc-text"> 3.4.2 retries(重试次数)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#343-batchsize批次大小和lingerms批次等待时间"><span class="toc-text"> 3.4.3 batch.size(批次大小)和linger.ms(批次等待时间)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#344-maxinflightrequestsperconnection"><span class="toc-text"> 3.4.4 max.in.flight.requests.per.connection</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#35-序列化器"><span class="toc-text"> 3.5 序列化器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#351-自定义序列化器"><span class="toc-text"> 3.5.1 自定义序列化器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#352-使用avro序列化"><span class="toc-text"> 3.5.2 使用Avro序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#353-在kafka中使用avro"><span class="toc-text"> 3.5.3 在Kafka中使用Avro</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#36-分区"><span class="toc-text"> 3.6 分区</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#361-自定义分区器"><span class="toc-text"> 3.6.1 自定义分区器</span></a></li></ol></li></ol></li></ol>
                                        </div>
                                        
                                            <h2 id="第3章-kafka生产者向kafka写入数据"><a class="markdownIt-Anchor" href="#第3章-kafka生产者向kafka写入数据"></a> 第3章 Kafka生产者——向Kafka写入数据</h2>
<blockquote>
<p>对应代码仓库地址:<a href="https://github.com/T0UGH/getting-started-kafka" target="_blank" rel="noopener">https://github.com/T0UGH/getting-started-kafka</a></p>
<p>参考资料:</p>
<p><strong>kafka权威指南</strong><a href="https://book.douban.com/subject/27665114/" target="_blank" rel="noopener">https://book.douban.com/subject/27665114/</a></p>
<p>大数据通用的序列化器——Apache Avro<a href="https://www.jianshu.com/p/0a85bfbb9f5f" target="_blank" rel="noopener">https://www.jianshu.com/p/0a85bfbb9f5f</a></p>
<p>Kafka 中使用 Avro 序列化框架(一)<a href="https://www.jianshu.com/p/4f724c7c497d" target="_blank" rel="noopener">https://www.jianshu.com/p/4f724c7c497d</a></p>
<p>Kafka 中使用 Avro 序列化组件(三)：Confluent Schema Registry<a href="https://www.jianshu.com/p/cd6f413d35b0" target="_blank" rel="noopener">https://www.jianshu.com/p/cd6f413d35b0</a></p>
</blockquote>
<p>本章对应代码仓库可查看<a href="https://github.com/T0UGH/getting-started-kafka/tree/main/src/main/java/cn/edu/neu/demo/ch3" target="_blank" rel="noopener">https://github.com/T0UGH/getting-started-kafka/tree/main/src/main/java/cn/edu/neu/demo/ch3</a></p>
<p>在这一章，我们将从<strong>Kafka生产者</strong>的<strong>设计</strong>和<strong>组件</strong>讲起，学习如何使用Kafka 生产者。</p>
<ol>
<li>我们将演示如何创建KafkaProducer和ProducerRecords对象、</li>
<li>如何将记录<strong>发送</strong>给Kafka</li>
<li>如何处理从Kafka返回的错误</li>
<li>介绍用于控制生产者行为的重要<strong>配置</strong>选项</li>
<li>深入探讨如何使用不同的<strong>分区</strong>方法和<strong>序列化器</strong>，以及如何自定义序列化器和分区器。</li>
</ol>
<h3 id="31-生产者概览"><a class="markdownIt-Anchor" href="#31-生产者概览"></a> 3.1 生产者概览</h3>
<p>先展示向Kafka发送消息的主要步骤</p>
<p><img src="https://healthlung.oss-cn-beijing.aliyuncs.com/20201123193012.png" alt=""></p>
<ol>
<li>
<p>首先<strong>创建</strong>一个<strong>ProducerRecord</strong>对象开始，ProducerRecord 对象需要包含目标<strong>主题</strong>和要发送的<strong>内容</strong>，有可能还包含<strong>键</strong>和<strong>分区</strong>信息</p>
</li>
<li>
<p>把ProducerRecord中的键和值<strong>序列化</strong>成字节数组，这样它们才能够在网络上传输</p>
</li>
<li>
<p>接下来，数据被传给<strong>分区器</strong>。</p>
<ul>
<li>如果之前在ProducerRecord对象里<strong>指定了分区</strong>，那么分区器就不会再做任何事情，直接把指定的分区<strong>返回</strong>。</li>
<li>如果<strong>没有指定分区</strong>，那么分区器会<strong>根据</strong>ProducerRecord对象的<strong>键</strong>来选择一个<strong>分区</strong>。</li>
</ul>
</li>
<li>
<p>紧接着，这条记录被添加到一个<strong>记录批次</strong>里，这个批次里的所有消息会被发送到相同的主题和分区上。</p>
</li>
<li>
<p>有一个<strong>独立的线程</strong>负责把这些记录批次<strong>发送</strong>到相应的broker 上。</p>
</li>
<li>
<p><strong>服务器</strong>在收到这些消息时会返回一个<strong>响应</strong>。</p>
<ul>
<li>
<p>如果消息<strong>成功</strong>写入Kafka，就返回一个<strong>RecordMetaData</strong>对象，它包含了<strong>主题</strong>和<strong>分区</strong>信息，以及记录在分区里的<strong>偏移量</strong>。</p>
</li>
<li>
<p>如果写入<strong>失败</strong>，则会返回一个<strong>错误</strong>。生产者在收到错误之后会尝试<strong>重新发送</strong>消息，几次之后如果还是失败，就返回错误信息。</p>
</li>
</ul>
</li>
</ol>
<h3 id="32-创建kafka生产者"><a class="markdownIt-Anchor" href="#32-创建kafka生产者"></a> 3.2 创建Kafka生产者</h3>
<p>下面展示如何创建一个KafkaProducer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Properties kafkaProperties = <span class="keyword">new</span> Properties();</span><br><span class="line"></span><br><span class="line"><span class="comment">// fixme: 运行时请修改47.94.139.116:9092为自己的kafka broker地址</span></span><br><span class="line">kafkaProperties.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"47.94.139.116:9092"</span>);</span><br><span class="line"></span><br><span class="line">kafkaProperties.put(<span class="string">"key.serializer"</span>,                     <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line"></span><br><span class="line">kafkaProperties.put(<span class="string">"value.serializer"</span>,                           <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line"></span><br><span class="line">kafkaProperties.put(<span class="string">"acks"</span>, <span class="string">"all"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据配置创建Kafka生产者</span></span><br><span class="line">KafkaProducer&lt;String, String&gt; kafkaProducer </span><br><span class="line">    = <span class="keyword">new</span> KafkaProducer&lt;String, String&gt;(kafkaProperties);</span><br></pre></td></tr></table></figure>
<p>在创建Kafka生产者之前，有3个必选的配置项</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>bootstrap.servers</td>
<td>该属性指定broker 的地址清单，地址的格式为host:port, host:port。</td>
</tr>
<tr>
<td>key.serializer</td>
<td>key.serializer 必须被设置为一个实现了org.apache.kafka.common.serialization.Serializer 接口的类，生产者会使用这个类<strong>把键序列化成字节数组</strong>。Kafka 客户端默认提供了ByteArraySerializer、StringSerializer 和IntegerSerializer</td>
</tr>
<tr>
<td>value.serializer</td>
<td>与key.serializer 一样，value.serializer 指定的类会<strong>将值序列化</strong>。</td>
</tr>
</tbody>
</table>
<h3 id="33-发送消息到kafka"><a class="markdownIt-Anchor" href="#33-发送消息到kafka"></a> 3.3 发送消息到Kafka</h3>
<p>实例化生产者对象后，接下来就可以开始发送消息了。发送消息主要有以下3 种方式：</p>
<ul>
<li><strong>发送并忘记</strong>（fire-and-forget）
<ul>
<li>我们把消息发送给服务器，但并<strong>不关心它是否正常到达</strong>。</li>
<li>大多数情况下，消息会正常到达，因为Kafka 是高可用的，而且生产者会自动尝试重发。</li>
<li>不过，使用这种方式有时候也会<strong>丢失一些消息</strong>。</li>
</ul>
</li>
<li><strong>同步发送</strong>
<ul>
<li>我们使用send() 方法发送消息，它会返回一个<strong>Future 对象</strong>，<strong>调用get() 方法进行等待</strong>，就可以知道消息是否发送成功。</li>
</ul>
</li>
<li><strong>异步发送</strong>
<ul>
<li>我们调用send() 方法，并指定一个<strong>回调函数</strong>，服务器在返回响应时调用该函数。</li>
</ul>
</li>
</ul>
<p>下面分别演示这三种方式</p>
<h4 id="331-发送并忘记"><a class="markdownIt-Anchor" href="#331-发送并忘记"></a> 3.3.1 发送并忘记</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(</span><br><span class="line">	<span class="string">"sun"</span>, <span class="string">"s1"</span>, <span class="string">"cn dota best dota"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    kafkaProducer.send(producerRecord);</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生产者的send() 方法将ProducerRecord对象作为参数。ProducerRecord中包含<strong>目标主题</strong>的名字和要发送的<strong>键</strong>对象和<strong>值</strong>对象。</li>
<li>我们使用生产者的<strong>send()方法</strong>发送ProducerRecord对象。send() 方法会<strong>返回</strong>一个包含RecordMetadata 的<strong>Future对象</strong>，不过因为我们这里忽略了返回值，所以无法知道消息是否发送成功。如果不关心发送结果，那么可以使用这种发送方式。比如，记录日志。</li>
<li>虽然我们忽略返回值的同时也忽略了返回的异常。不过在<strong>发送消息之前</strong>，生产者还是有可能发生其他的<strong>异常</strong>，这些异常将被抛出。这些异常有可能是：
<ul>
<li>SerializationException（说明序列化消息失败）</li>
<li>BufferExhaustedException 或TimeoutException（说明缓冲区已满）</li>
<li>又或者是InterruptException（说明发送线程被中断）。</li>
</ul>
</li>
</ul>
<h4 id="332-同步发送"><a class="markdownIt-Anchor" href="#332-同步发送"></a> 3.3.2 同步发送</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(</span><br><span class="line">	<span class="string">"sun"</span>, <span class="string">"s1"</span>, <span class="string">"cn dota best dota"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    kafkaProducer.send(producerRecord).get();</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>producer.send()方法先返回一个Future对象，然后调用Future 对象的<strong>get()方法</strong>会<strong>阻塞当前线程</strong>来等待Kafka响应。</p>
<ul>
<li>如果服务器返回一个<strong>错误</strong>，get() 方法会<strong>抛出异常</strong>。</li>
<li><strong>否则</strong>，我们会得到一个<strong>RecordMetadata</strong>对象，可以通过它获取消息的<strong>主题</strong>、<strong>分区</strong>、<strong>偏移量</strong>等信息。</li>
</ul>
</li>
<li>
<p>如果在<strong>发送消息之前</strong>或者在<strong>发送消息的过程中</strong>发生了任何<strong>错误</strong>，比如broker 返回了一个不允许重发消息的异常或者已经超过了重发的次数，那么就会<strong>抛出异常</strong>。</p>
</li>
</ul>
<p>KafkaProducer一般会发生两类错误。</p>
<ul>
<li>一类是<strong>可重试错误</strong>，这类错误可以通过重发消息来解决。比如对于连接错误，可以通过再次建立连接来解决，“无主（no leader）”错误则可以通过重新为分区选举首领来解决。KafkaProducer 可以被配置成自动重试，如果在<strong>多次重试后仍无法解决问题</strong>，应用程序会收到一个<strong>重试异常</strong>。</li>
<li>另一类错误<strong>无法通过重试解决</strong>，比如“消息太大”异常。对于这类错误，KafkaProducer<strong>直接抛出异常</strong>。</li>
</ul>
<h4 id="333-异步发送"><a class="markdownIt-Anchor" href="#333-异步发送"></a> 3.3.3 异步发送</h4>
<p>如果只发送消息而不等待响应，那么可以<strong>避免阻塞</strong>线程来等待，从而提高发送效率。</p>
<p>大多数时候，我们并不需要等待响应——尽管Kafka会把目标主题、分区信息和消息的偏移量发送回来，但对于发送端的应用程序来说不是必需的。不过在<strong>遇到消息发送失败时</strong>，我们需要<strong>抛出异常</strong>、<strong>记录错误日志</strong>，或者把消息<strong>写入</strong>“错误消息”<strong>文件</strong>以便日后分析。</p>
<p>这时我们可以为send()方法<strong>注册一个回调函数</strong>，让它来处理异步调用的返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建ProducerRecord，它是一种消息的数据结构</span></span><br><span class="line">ProducerRecord&lt;String, String&gt; producerRecord </span><br><span class="line">    = <span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="string">"sun"</span>, <span class="string">"s1"</span>, <span class="string">"cn dota best dota"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line">kafkaProducer.send(producerRecord, <span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata recordMetadata, Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(e != <span class="keyword">null</span>)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(recordMetadata);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>这里通过注册一个<strong>回调函数</strong>来<strong>处理异步</strong>发送的结果
<ul>
<li>如果错误，则<code>onCompletion</code>方法的<code>Exception</code>参数不为null，我们可以针对这个异常进行处理</li>
<li>如果没有错误，<code>RecordMetadata</code>不为null，我们可以从中获取主题信息、分区信息、偏移量信息</li>
</ul>
</li>
</ul>
<h3 id="34-生产者的配置"><a class="markdownIt-Anchor" href="#34-生产者的配置"></a> 3.4 生产者的配置</h3>
<p>生产者还有很多可配置的参数，在Kafka 文档里都有说明，它们大部分都有合理的默认值，所以没有必要去修改它们。不过有几个参数在内存使用、性能和可靠性方面对生产者影响比较大，接下来我们会一一说明。</p>
<h4 id="341-acks"><a class="markdownIt-Anchor" href="#341-acks"></a> 3.4.1 acks</h4>
<p><strong>acks</strong>参数指定了必须<strong>要有多少个分区副本收到消息</strong>，<strong>生产者</strong>才会<strong>认为消息写入是成功</strong>的。</p>
<ul>
<li>
<p>如果acks=0，<strong>生产者发送消息之后就立刻认为消息写入成功</strong>。</p>
<ul>
<li>也就是说，如果服务器没有收到消息，生产者也无从得知，消息也就丢失了。</li>
<li>不过，因为<strong>生产者不需要等待服务器的响应</strong>，所以它可以以网络能够支持的最大速度发送消息，从而达到很高的<strong>吞吐量</strong>。</li>
</ul>
</li>
<li>
<p>如果acks=1，只要<strong>集群的首领节点收到消息</strong>，生产者就会<strong>收到</strong>一个来自服务器的<strong>成功响应</strong>。</p>
<ul>
<li>如果消息无法到达首领节点（比如首领节点崩溃，新的首领还没有被选举出来），生产者会收到一个错误响应，为了避免数据丢失，生产者会重发消息。</li>
</ul>
</li>
<li>
<p>如果acks=all，只有当<strong>首领节点</strong>和<strong>所有复制节点</strong>全部<strong>收到消息</strong>时，生产者才会收到一个来自服务器的<strong>成功响应</strong>。</p>
<ul>
<li>这种模式是<strong>最安全</strong>的。</li>
<li>不过，它的<strong>延迟</strong>比acks=1 时更高，因为我们要等待不只一个服务器节点接收消息。</li>
</ul>
</li>
</ul>
<h4 id="342-retries重试次数"><a class="markdownIt-Anchor" href="#342-retries重试次数"></a> 3.4.2 retries(重试次数)</h4>
<p>retries 参数的值决定了<strong>生产者可以重发消息的次数</strong>，如果达到这个次数，生产者会放弃重试并返回错误。默认情况下，生产者会在每次<strong>重试之间等待</strong>100ms。</p>
<p>因为<strong>生产者会自动进行重试</strong>，所以就<strong>没必要</strong>在代码逻辑里<strong>处理那些可重试的错误</strong>。你只需要处理那些不可重试的错误或重试次数超出上限的情况。</p>
<h4 id="343-batchsize批次大小和lingerms批次等待时间"><a class="markdownIt-Anchor" href="#343-batchsize批次大小和lingerms批次等待时间"></a> 3.4.3 batch.size(批次大小)<a href="http://xn--linger-h76j.ms" target="_blank" rel="noopener">和linger.ms</a>(批次等待时间)</h4>
<p>KafkaProducer会在<strong>批次填满</strong><a href="http://xn--linger-o06l.ms" target="_blank" rel="noopener">或linger.ms</a><strong>达到上限</strong>时把批次<strong>发送</strong>出去。</p>
<p>该参数指定了一个<strong>批次可以使用的内存大小</strong>，<strong>按照字节数计算</strong>（而<strong>不是</strong>消息<strong>个数</strong>）。当批次被填满，批次里的所有消息会被发送出去。</p>
<p>该参数指定了生产者在发送批次之前<strong>等待更多消息加入批次的时间</strong></p>
<h4 id="344-maxinflightrequestsperconnection"><a class="markdownIt-Anchor" href="#344-maxinflightrequestsperconnection"></a> 3.4.4 max.in.flight.requests.per.connection</h4>
<p>该参数指定了<strong>生产者</strong>在<strong>收到服务器响应之前可以发送多少个消息</strong>。</p>
<ul>
<li>它的值越高，就会占用越多的内存，不过也会提升吞吐量。</li>
<li>把它<strong>设为1</strong>可以保证消息是按照发送的<strong>顺序写入</strong>服务器的，即使发生了重试。</li>
</ul>
<h3 id="35-序列化器"><a class="markdownIt-Anchor" href="#35-序列化器"></a> 3.5 序列化器</h3>
<p>我们已经在之前的例子里看到，创建一个生产者对象必须指定序列化器。我们已经知道如何使用默认的字符串序列化器，Kafka 还提供了整型和字节数组序列化器，不过它们还不足以满足大部分场景的需求。到最后，我们需要序列化的记录类型会越来越多。</p>
<p>接下来演示如何开发<strong>自定义序列化器</strong>，并介绍<strong>Avro序列化器</strong>。如果<strong>发送到Kafka的对象</strong> <strong>不是</strong>简单的<strong>字符串</strong>或<strong>整型</strong>，那么可以使用<strong>序列化框架</strong>来创建消息记录，如Avro、Thrift 或Protobuf，或者使用自定义序列化器。我们强烈<strong>建议使用通用的序列化框架</strong>。</p>
<h4 id="351-自定义序列化器"><a class="markdownIt-Anchor" href="#351-自定义序列化器"></a> 3.5.1 自定义序列化器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个简单的pojo，为了演示如何自定义序列化器</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> customerId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String customerName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(<span class="keyword">int</span> customerId, String customerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.customerId = customerId;</span><br><span class="line">        <span class="keyword">this</span>.customerName = customerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCustomerId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> customerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomerId</span><span class="params">(<span class="keyword">int</span> customerId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.customerId = customerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCustomerName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> customerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomerName</span><span class="params">(String customerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.customerName = customerName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义序列化器</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerSerializer</span> <span class="keyword">implements</span> <span class="title">Serializer</span>&lt;<span class="title">Customer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs, <span class="keyword">boolean</span> isKey)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不需要配置任何</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Customer对象的序列化函数，组成如下</span></span><br><span class="line"><span class="comment">     * 前4字节: customerId</span></span><br><span class="line"><span class="comment">     * 中间4字节: customerName字节数组长度</span></span><br><span class="line"><span class="comment">     * 后面n字节: customerName字节数组</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String topic, Customer data) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">byte</span>[] serializedName;</span><br><span class="line">            <span class="keyword">int</span> stringSize;</span><br><span class="line">            <span class="keyword">if</span>(data == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(data.getCustomerName() != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    serializedName = data.getCustomerName().getBytes(<span class="string">"utf-8"</span>);</span><br><span class="line">                    stringSize = serializedName.length;</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                    serializedName = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">                    stringSize = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate(<span class="number">4</span> + <span class="number">4</span> + stringSize);</span><br><span class="line">            buffer.putInt(data.getCustomerId());</span><br><span class="line">            buffer.putInt(stringSize);</span><br><span class="line">            buffer.put(serializedName);</span><br><span class="line">            <span class="keyword">return</span> buffer.array();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(</span><br><span class="line">                <span class="string">"Error when serializing Customer to byte[] "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String topic, Headers headers, Customer data) &#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(topic, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不需要关闭任何</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过我们不建议采用自定义序列化器，理由如下</p>
<ul>
<li>如果我们有多种类型的消费者，可能需要把customerID 字段变成长整型，或者为Customer 添加startDate 字段，这样就会出现<strong>新旧消息的兼容性问题</strong>。</li>
<li>在不同版本的序列化器和反序列化器之间<strong>调试兼容性</strong>问题着实是个<strong>挑战</strong>——你需要比较原始的字节数组。</li>
<li>更糟糕的是，如果同一个公司的<strong>不同团队</strong>都需要往Kafka 写入Customer 数据，那么他们就需要使用相同的序列化器，如果<strong>序列化器发生改动</strong>，<strong>他们几乎都要在同一时间修改代码</strong>。</li>
</ul>
<h4 id="352-使用avro序列化"><a class="markdownIt-Anchor" href="#352-使用avro序列化"></a> 3.5.2 使用Avro序列化</h4>
<p>Apache Avro是一种与<strong>编程语言无关</strong>的<strong>序列化格式</strong>。</p>
<p><strong>Avro数据</strong>通过与语言无关的<strong>schema来定义</strong>。</p>
<ul>
<li><strong>schema通过JSON来描述</strong>，</li>
<li>数据可以被序列化成二进制文件或JSON 文件，不过一般会使用二进制文件。</li>
<li>Avro 在<strong>读写文件</strong>时<strong>需要用到schema</strong>，schema 一般会被<strong>内嵌</strong>在数据文件里。</li>
</ul>
<p>Avro 有一个很有意思的特性是，当负责<strong>写消息的应用程序</strong>使用了<strong>新版本的schema</strong>，负责<strong>读消息的应用程序</strong>可以继续处理消息而<strong>无需做任何改动</strong>，这个特性使得它特别适合用在像Kafka 这样的消息系统上。</p>
<p>下面举个例子</p>
<blockquote>
<p>假设我们有一个v0.0.1的schema</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt; "namespace": "customerManagement.avro",</span><br><span class="line">&gt; 	"type": "record",</span><br><span class="line">&gt; 	"name": "Customer",</span><br><span class="line">&gt; 	"fields": [</span><br><span class="line">&gt; 		&#123;"name": "id", "type": "int"&#125;,</span><br><span class="line">&gt; 		&#123;"name": "name", "type": "string"&#125;,</span><br><span class="line">&gt; 		&#123;"name": "faxNumber", "type": ["null", "string"], "default": "null"&#125; </span><br><span class="line">&gt; 	]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>过了一段时间，我们需要删除<code>faxnumber</code>字段(传真号码)，添加一个<code>email</code>字段，新的schema(v0.0.2)如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt; "namespace": "customerManagement.avro",</span><br><span class="line">&gt; 	"type": "record",</span><br><span class="line">&gt; 	"name": "Customer",</span><br><span class="line">&gt; 	"fields": [</span><br><span class="line">&gt; 		&#123;"name": "id", "type": "int"&#125;,</span><br><span class="line">&gt; 		&#123;"name": "name", "type": "string"&#125;,</span><br><span class="line">&gt; 		&#123;"name": "email", "type": ["null", "string"], "default": "null"&#125; </span><br><span class="line">&gt; 	]</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>更新到新版的schema 后:</p>
<ul>
<li>旧记录仍然包含faxNumber 字段</li>
<li>而新记录则包含email 字段</li>
<li><strong>部分</strong>负责<strong>读取数据的应用程序</strong>进行了<strong>升级</strong>，那么它们是如何处理这些变化的呢？</li>
</ul>
<p>在<strong>消费者升级之前</strong>：</p>
<ul>
<li>它们会调用类似getName()、getId() 和getFaxNumber() 这样的方法。</li>
<li>如果碰到使用新schema 构建的消息，getName() 和getId() 方法仍然能够正常返回，但getFaxNumber() 方法会返回null，因为消息里不包含传真号码。</li>
</ul>
<p>在<strong>消费者升级之后</strong></p>
<ul>
<li>getEmail() 方法取代了getFaxNumber() 方法。</li>
<li>如果碰到一个使用旧schema 构建的消息，那么getEmail() 方法会返回null，因为旧消息不包含邮件地址。</li>
</ul>
<p>现在可以看出使用Avro 的好处了：我们<strong>修改了消息的schema</strong>，但并<strong>不需要更新所有消费者</strong>，而这样仍然不会出现异常或阻断性错误，也不需要对现有数据进行大幅更新。</p>
</blockquote>
<h4 id="353-在kafka中使用avro"><a class="markdownIt-Anchor" href="#353-在kafka中使用avro"></a> 3.5.3 在Kafka中使用Avro</h4>
<p>如果在每条Kafka 记录里都嵌入schema，会让记录的大小成倍地增加。</p>
<ul>
<li>但是在<strong>读取记录</strong>时仍然<strong>需要用到整个schema</strong>，所以要先找到schema。</li>
<li>我们要使用“<strong>schema 注册表</strong>”来达到目的。</li>
<li>Kafka中并不包含schema注册表的实现，现在已经有一些开源的schema注册表实现，比如：Confluent Schema Registry。</li>
<li>我们把所有写入数据需要用到的<strong>schema保存在注册表里</strong>，然后在<strong>记录里放一个schema的标识符</strong>。</li>
<li><strong>消费者</strong>使用记录中的标识符<strong>从注册表里拉取schema</strong>来反序列化记录。</li>
</ul>
<p><img src="https://healthlung.oss-cn-beijing.aliyuncs.com/20201124195244.png" alt=""></p>
<h3 id="36-分区"><a class="markdownIt-Anchor" href="#36-分区"></a> 3.6 分区</h3>
<p>在之前的例子里，<strong>ProducerRecord对象</strong>包含了目标<strong>主题</strong>、<strong>键</strong>和<strong>值</strong>。Kafka 的<strong>消息</strong>是一个个<strong>键值对</strong>，ProducerRecord 对象<strong>可以只包含目标主题和值</strong>，<strong>键</strong>可以设置为默认的<strong>null</strong>，不过大多数应用程序会用到键。</p>
<p>键有两个用途：</p>
<ol>
<li>可以作为消息的<strong>附加信息</strong>，</li>
<li>也可以用来<strong>决定消息该被写到主题的哪个分区</strong>。拥有相同键的消息将被写到同一个分区。</li>
</ol>
<p>如果要创建键为null的消息，不指定键就可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProducerRecord&lt;Integer, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"CustomerCountry"</span>, <span class="string">"USA"</span>);</span><br></pre></td></tr></table></figure>
<p>如果<strong>键为null</strong>，并且使用了默认的分区器，那么记录将被随机地发送到主题内各个可用的分区上。分区器使用<strong>轮询（Round Robin）算法</strong>将消息均衡地分布到各个分区上。</p>
<p>如果<strong>键不为空</strong>，并且使用了默认的分区器，那么Kafka会使用<strong>Kafka自己的散列算法</strong>对键进行<strong>散列</strong>（使用Kafka 自己的散列算法，即使升级Java 版本，散列值也不会发生变化），然后根据散列值把消息<strong>映射到特定的分区</strong>上。这里的关键之处在于，<strong>同一个键总是被映射到同一个分区上</strong>。</p>
<p>只有在<strong>不改变主题分区数量的情况下</strong>，键与分区之间的映射才能保持不变。举个例子，在分区数量保持不变的情况下，可以保证用户045189 的记录总是被写到分区34。在从分区读取数据时，可以进行各种优化。不过，一旦主题增加了新的分区，这些就无法保证了——旧数据仍然留在分区34，但新的记录可能被写到其他分区上。<strong>如果要使用键来映射分区，那么最好在创建主题的时候就把分区规划好，而且永远不要增加新分区。</strong></p>
<h4 id="361-自定义分区器"><a class="markdownIt-Anchor" href="#361-自定义分区器"></a> 3.6.1 自定义分区器</h4>
<p><strong>默认情况下</strong>，kafka自动创建的主题的<strong>分区数量为1</strong>，所以我们需要先修改分区数量，来让自定义分区器有点用。</p>
<ol>
<li>
<p>先cd到<code>opt\kafka\bin\</code></p>
</li>
<li>
<p>运行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --zookeeper 47.94.139.116:2181/kafka --alter --topic sun --partitions 4</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>查看是否修改成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --describe --zookeeper 47.94.139.116:2181/kafka --topic sun</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://healthlung.oss-cn-beijing.aliyuncs.com/20201124201605.png" alt=""></p>
<p>或者也可以通过修改<code>server.properties</code>中的<code>nums.partions</code>并重启，来更改默认分区数量。</p>
<p>下面自定义一个分区器，它根据键来划分分区：若键为Banana则放入最后一个分区，若键不为Banana则散列到其他分区。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义分区器</span></span><br><span class="line"><span class="comment"> * 若键为Banana则放入最后一个分区，若键不为Banana则散列到其他分区</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BananaPartitioner</span> <span class="keyword">implements</span> <span class="title">Partitioner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分区信息列表</span></span><br><span class="line">        List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分区数量</span></span><br><span class="line">        <span class="keyword">int</span> partitionsAmount = partitions.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果只有一个分区，那全都放到partition0就完事了</span></span><br><span class="line">        <span class="keyword">if</span>(partitionsAmount == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(keyBytes == <span class="keyword">null</span> || ! (key <span class="keyword">instanceof</span> String))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidRecordException(<span class="string">"We expect all messages to have customer name as key"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(key.equals(<span class="string">"Banana"</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> partitionsAmount - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (Math.abs(Utils.murmur2(keyBytes)) % (partitionsAmount - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，在producer配置中加入<code>kafkaProperties.put(&quot;partitioner.class&quot;, &quot;cn.edu.neu.demo.ch3.partitioner.BananaPartitioner&quot;);</code>即可。</p>

                                                
            </div>
            <div class="article-footer">
                <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://t0ugh.biz/2020/11/24/Kafka-3-Kafka生产者/" title="[Kafka][3][Kafka生产者]" target="_blank" rel="external">https://t0ugh.biz/2020/11/24/Kafka-3-Kafka生产者/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/t0ugh" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://i.loli.net/2020/03/21/WAKimNUecFR64uo.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/t0ugh" target="_blank"><span class="text-dark">T0UGH</span><small class="ml-1x">学生&amp;编程爱好者</small></a></h3>
        <div>很拽很拽很拽很拽很拽很拽很拽很拽</div>
      </div>
    </figure>
  </div>
</div>


            </div>
    </article>
    
        
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


            
</div>

    <nav class="bar bar-footer clearfix" data-stick-bottom="">
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/2020/11/22/Kafka-1-初识Kafka/" title="[Kafka][1][初识Kafka]"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
        

            
</main>

  <footer class="footer" itemscope="" itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/t0ugh" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: 'E1MH6h0YP3yhA0PJsohNBgiT-gzGzoHsz',
    appKey: 'YOiN6zLq3XGfKmlR0b8vyHtN',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>